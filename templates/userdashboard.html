<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lend A Hand - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All your existing CSS remains exactly the same */
        :root {
            --primary: #2c5282;
            --primary-light: #4299e1;
            --secondary: #38a169;
            --secondary-light: #68d391;
            --accent: #e53e3e;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #a0aec0;
            --gray-light: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 80px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            min-height: 100vh;
            display: flex;
        }
         .goog-te-banner-frame,
    .goog-te-banner,
    .goog-te-banner-wrapper,
    .skiptranslate,
    #goog-gt-tt,
    .goog-te-balloon-frame,
    .goog-tooltip,
    .goog-tooltip:hover,
    .goog-text-highlight {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        width: 0 !important;
        position: absolute !important;
    }
    
    /* Prevent body shift */
    body {
        top: 0px !important;
        position: static !important;
    }
    
    /* Hide the translation menu if it appears */
    .goog-te-menu-frame {
        display: none !important;
    }
        /* ================= REVIEW SECTION STYLES ================= */

#reviews-section .reviews-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Review Card Styles */
.review-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
    transition: all 0.3s ease;
}

.review-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.review-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
}

.review-equipment-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.review-equipment-img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
}

.review-equipment-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.review-equipment-img .default-icon {
    font-size: 1.5rem;
    color: var(--gray);
}

.review-equipment-details h4 {
    margin: 0 0 5px 0;
    color: var(--dark);
    font-size: 1.1rem;
}

.review-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.review-vendor {
    color: var(--gray);
    font-size: 0.9rem;
}

.review-date {
    color: var(--gray);
    font-size: 0.85rem;
}

/* Star Rating Styles */
.star-rating {
    display: flex;
    gap: 3px;
    margin: 5px 0;
}

.star-rating i {
    color: #f59e0b;
    font-size: 1rem;
}

.review-content {
    margin-top: 15px;
}

.review-title {
    color: var(--primary);
    margin: 0 0 10px 0;
    font-size: 1.1rem;
}

.review-comment {
    color: var(--dark);
    line-height: 1.5;
    margin: 0;
}

.review-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--gray-light);
}

/* Review Modal Styles */
#reviewModal .modal-content {
    max-width: 700px;
}

#reviewModal .rating-stars {
    display: flex;
    gap: 10px;
    margin: 15px 0;
}

#reviewModal .rating-stars i {
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.2s ease;
}

#reviewModal .rating-stars i:hover {
    transform: scale(1.1);
}

/* Selected Order Info Box */
#selectedOrderInfo {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Order Type Badges */
.badge-review-booking {
    background: #bee3f8;
    color: #2c5282;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-review-rental {
    background: #c6f6d5;
    color: #2f855a;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Empty State Styles */
.no-reviews {
    text-align: center;
    padding: 60px 20px;
}

.no-reviews i {
    font-size: 4rem;
    color: var(--gray-light);
    margin-bottom: 20px;
    display: block;
}

.no-reviews h3 {
    color: var(--dark);
    margin-bottom: 10px;
    font-size: 1.5rem;
}

.no-reviews p {
    color: var(--gray);
    font-size: 1rem;
    max-width: 400px;
    margin: 0 auto;
}

/* Responsive Styles */
@media (max-width: 768px) {
    .review-card-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .review-equipment-info {
        width: 100%;
    }
    
    .review-actions {
        justify-content: flex-start;
    }
    
    #reviewModal .rating-stars i {
        font-size: 1.8rem;
    }
    
    #reviewModal .modal-content {
        width: 95%;
        margin: 10px;
    }
}

@media (max-width: 576px) {
    .review-equipment-info {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .review-equipment-img {
        width: 80px;
        height: 80px;
    }
    
    #reviewModal .rating-stars i {
        font-size: 1.5rem;
    }
    
    .review-meta {
        flex-wrap: wrap;
    }
}

/* Star Hover Effects */
.rating-stars i {
    transition: all 0.2s ease;
}

.rating-stars i:hover,
.rating-stars i.hovered {
    color: #f59e0b;
    transform: scale(1.1);
}

/* Form Validation Styles */
#reviewForm input:invalid,
#reviewForm textarea:invalid,
#reviewForm select:invalid {
    border-color: #fc8181;
}

#reviewForm input:valid,
#reviewForm textarea:valid,
#reviewForm select:valid {
    border-color: #68d391;
}

/* Loading State */
.review-loading {
    opacity: 0.7;
    pointer-events: none;
}

/* Success Message */
.review-success {
    background: #c6f6d5;
    color: #2f855a;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 15px 0;
    display: none;
}

.review-success.show {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
        /* Order Details Modal Styles */
.order-details-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.details-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
}

.details-section h4 {
    color: var(--primary);
    margin-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
    padding-bottom: 5px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e9ecef;
}

.detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.detail-label {
    font-weight: 600;
    color: var(--dark);
    min-width: 150px;
}

.detail-value {
    color: var(--gray);
    text-align: right;
    flex: 1;
}

.status-pending { 
    color: #856404; 
    background: #fff3cd; 
    padding: 2px 8px; 
    border-radius: 4px; 
}

.status-confirmed { 
    color: #0c5460; 
    background: #d1ecf1; 
    padding: 2px 8px; 
    border-radius: 4px; 
}

.status-cancelled { 
    color: #721c24; 
    background: #f8d7da; 
    padding: 2px 8px; 
    border-radius: 4px; 
}

.status-completed { 
    color: #155724; 
    background: #d4edda; 
    padding: 2px 8px; 
    border-radius: 4px; 
}
           /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            color: white;
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            left: 0;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar.collapsed .logo span,
        .sidebar.collapsed .nav-link span {
            display: none;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo span {
            color: var(--secondary-light);
            transition: opacity 0.3s ease;
        }
        
        .toggle-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .nav-links {
            list-style: none;
            padding: 0 15px;
        }
        
        .nav-links li {
            margin-bottom: 5px;
        }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: white;
            border-radius: 8px;
            transition: all 0.3s;
            gap: 12px;
            cursor: pointer;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-links i {
            width: 20px;
            text-align: center;
        }
        .cancellation-note {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #c53030;
}

.cancellation-note i {
    margin-right: 5px;
}

.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--gray-light);
}
        /* Add these CSS fixes for loan calculator */
.calculator-form {
    background: #f9f9f9;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    border: 1px solid var(--gray-light);
}

.calculator-results {
    background: #f0f7ff;
    padding: 20px;
    border-radius: var(--radius);
    border: 1px solid var(--primary-light);
    margin-top: 15px;
}

.schedule-container {
    margin-top: 20px;
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    border: 1px solid var(--gray-light);
}

/* Ensure proper spacing in booking modal */
.booking-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.booking-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary);
}

/* Make calculator sections more visible */
.calculator-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--gray-light);
}

.calculator-section:last-child {
    border-bottom: none;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--dark);
}

.value-display {
    margin-top: 5px;
    font-weight: 600;
    color: var(--primary);
    font-size: 0.9rem;
}
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px 30px;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: var(--sidebar-collapsed-width);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .welcome h2 {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .welcome p {
            color: var(--gray);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .notification-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            color: var(--dark);
        }
        
        .notification-btn::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: 8px;
            right: 8px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .user-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-light);
            background-color: #ddd;
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .stat-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-icon.blue {
            background: rgba(66, 153, 225, 0.2);
            color: var(--primary-light);
        }
        
        .stat-icon.green {
            background: rgba(104, 211, 145, 0.2);
            color: var(--secondary);
        }
        
        .stat-icon.orange {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
        }
        
        .stat-icon.red {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
        }
        
        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Orders Section Styles */
.equipment-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.equipment-thumb {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
}

.equipment-thumb.no-image {
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #666;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d1ecf1; color: #0c5460; }
.status-approved { background: #d4edda; color: #155724; }
.status-completed { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-rejected { background: #f8d7da; color: #721c24; }

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-danger { background: #dc3545; color: white; }

/* Order Details Preview */
.order-details-preview {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 15px 0;
}

.order-details-preview p {
    margin: 5px 0;
}
        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .menu-toggle {
                display: block;
            }
        }
        
        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 15px;
        }
        
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* Content Sections */
        .content-section {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            color: var(--dark);
        }
        /* Orders Section Styles */
.equipment-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.equipment-thumb {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
}

.equipment-thumb.no-image {
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #666;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d1ecf1; color: #0c5460; }
.status-approved { background: #d4edda; color: #155724; }
.status-completed { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-rejected { background: #f8d7da; color: #721c24; }

.action-buttons {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-danger { background: #dc3545; color: white; }

/* Order Details Preview */
.order-details-preview {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 15px 0;
}

.order-details-preview p {
    margin: 5px 0;
}
        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .item-card {
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            overflow: hidden;
            transition: all 0.3s;
            background: white;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .item-img {
            height: 180px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            overflow: hidden;
            position: relative;
        }
        
        .item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-available {
            background: #c6f6d5;
            color: #2f855a;
        }
        
        .badge-unavailable {
            background: #fed7d7;
            color: #c53030;
        }
        
        .badge-maintenance {
            background: #feebcb;
            color: #b45309;
        }
        
        .item-info {
            padding: 15px;
        }
        
        .item-info h3 {
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 1.2rem;
        }
        
        .item-info p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .item-price {
            font-size: 1.3rem;
            color: var(--secondary);
            font-weight: 700;
            margin: 10px 0;
        }
        
        .item-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        .item-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
        }
        
        .btn-success {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--secondary-light);
        }
        
        .btn-danger {
            background: var(--accent);
            color: white;
        }
        
        .btn-danger:hover {
            background: #fc8181;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.4rem;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            min-width: 600px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .data-table th {
            background-color: var(--gray-light);
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            color: var(--gray);
        }
        
        .filter-dropdown {
            min-width: 180px;
        }
        
        /* Calculator Styles */
        .calculator-container {
            margin-top: 30px;
            border-top: 1px solid var(--gray-light);
            padding-top: 20px;
        }
        
        .calculator-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calculator-toggle label {
            margin-right: 10px;
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .calculator-toggle select {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
        }
        
        .calculator-form {
            display: none;
            background: #f9f9f9;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .calculator-subheader {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .value-display {
            margin-top: 5px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .metrics-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-box {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .metric-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .btn-calculate, .btn-download {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .btn-calculate:hover, .btn-download:hover {
            background-color: var(--primary-light);
        }
        
        .schedule-container {
            margin-top: 20px;
            display: none;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .schedule-table th, .schedule-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .schedule-table th {
            background-color: var(--gray-light);
            font-weight: 600;
        }
        
        .tips-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .tip-box {
            flex: 1;
            background: #f9f9f9;
            padding: 15px;
            border-radius: var(--radius);
            border-left: 4px solid var(--secondary);
        }
        
        .tip-title {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
            font-size: 0.9rem;
            color: var(--gray);
            text-align: center;
        }
        
        .btn-book {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: block;
            margin: 30px auto 0;
            transition: background-color 0.3s;
        }
        
        .btn-book:hover {
            background-color: var(--primary-light);
        }
        
        /* Cart Styles */
        .cart-icon {
            position: relative;
        }
        
        .cart-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .metrics-container {
                flex-direction: column;
            }
            
            .tips-container {
                flex-direction: column;
            }
        }
        .btn-place-order {
    background-color: var(--secondary);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    display: block;
    margin: 20px auto 0;
    transition: background-color 0.3s;
    width: 200px;
}

.btn-place-order:hover {
    background-color: var(--secondary-light);
}

.btn-place-order:disabled {
    background-color: var(--gray);
    cursor: not-allowed;
}
/* Booking Modal Styles */
.booking-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 20px;
}

.booking-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.booking-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary);
}

.section-title {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 1.2rem;
    border-bottom: 2px solid var(--gray-light);
    padding-bottom: 8px;
}

.equipment-card {
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.equipment-card h3 {
    color: var(--dark);
    margin-bottom: 10px;
}

.equipment-card p {
    color: var(--gray);
    margin-bottom: 15px;
}

.equipment-card .equipment-meta {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}

.equipment-card .equipment-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--dark);
    font-size: 0.9rem;
}

.pricing-summary {
    background: white;
    padding: 15px;
    border-radius: var(--radius);
}

.price-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--gray-light);
}

.price-line.total {
    border-top: 2px solid var(--primary);
    border-bottom: none;
    padding-top: 10px;
    margin-top: 10px;
    font-size: 1.1rem;
}

.calculator-subtitle {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.calculator-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--gray-light);
}

.calculator-section:last-child {
    border-bottom: none;
}

.table-container {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 15px;
    border: 1px solid var(--gray-light);
    border-radius: var(--radius);
}

.tips-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.tip-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: var(--radius);
    border-left: 3px solid var(--secondary);
}

.tip-box i {
    color: var(--secondary);
    font-size: 1.2rem;
    margin-top: 2px;
}

.tip-box h4 {
    color: var(--dark);
    margin-bottom: 4px;
    font-size: 1rem;
}

.tip-box p {
    color: var(--gray);
    font-size: 0.9rem;
    margin: 0;
}

/* Responsive Design for Booking Modal */
@media (max-width: 992px) {
    .booking-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .booking-column {
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .booking-section {
        padding: 15px;
    }
    
    .equipment-card .equipment-meta {
        flex-direction: column;
        gap: 8px;
    }
    
    .tips-container {
        gap: 10px;
    }
    
    .tip-box {
        flex-direction: column;
        text-align: center;
        gap: 8px;
    }
}
        
        
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #f6ad55;
        }
        /* Smaller Equipment Action Buttons */
.item-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    gap: 5px;
    flex-wrap: wrap;
}

.item-actions .btn {
    padding: 4px 8px;
    font-size: 0.7rem;
    min-width: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    flex: 1;
    text-align: center;
}

.item-actions .btn i {
    font-size: 0.6rem;
}

/* Make the buttons even more compact */
.item-actions .btn-sm {
    padding: 3px 6px;
    font-size: 0.65rem;
    min-width: 55px;
}

/* Ensure text doesn't wrap */
.item-actions .btn span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Specific button adjustments */
.book-btn, .rent-btn, .wishlist-btn, .cart-btn {
    min-height: 24px;
    line-height: 1.2;
}

/* For the remove button in wishlist */
.remove-wishlist-btn {
    background: var(--accent) !important;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.remove-wishlist-btn i {
    font-size: 0.7rem;
    margin: 0;
}

/* Responsive adjustments for buttons */
@media (max-width: 768px) {
    .item-actions {
        gap: 3px;
    }
    
    .item-actions .btn {
        padding: 3px 6px;
        font-size: 0.65rem;
        min-width: 50px;
    }
    
    .item-actions .btn i {
        font-size: 0.55rem;
    }
}
/* Add these CSS fixes for loan calculator */
.calculator-form {
    background: #f9f9f9;
    padding: 20px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    border: 1px solid var(--gray-light);
}

.calculator-results {
    background: #f0f7ff;
    padding: 20px;
    border-radius: var(--radius);
    border: 1px solid var(--primary-light);
    margin-top: 15px;
}

.schedule-container {
    margin-top: 20px;
    background: white;
    padding: 15px;
    border-radius: var(--radius);
    border: 1px solid var(--gray-light);
}

/* Ensure proper spacing in booking modal */
.booking-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.booking-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: var(--radius);
    border-left: 4px solid var(--primary);
}

/* Make calculator sections more visible */
.calculator-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--gray-light);
}

.calculator-section:last-child {
    border-bottom: none;
}

.input-group {
    margin-bottom: 15px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--dark);
}

.value-display {
    margin-top: 5px;
    font-weight: 600;
    color: var(--primary);
    font-size: 0.9rem;
}
/* Ensure the item card has enough space for buttons */
.item-card {
    min-height: 420px;
    display: flex;
    flex-direction: column;
}

.item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.item-actions {
    margin-top: auto;
}
/* Orders Section Styles */
.orders-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.order-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary);
    transition: all 0.3s ease;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--gray-light);
}

.order-title {
    font-size: 1.2rem;
    color: var(--dark);
    margin: 0;
}

.order-type-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-booking {
    background: #bee3f8;
    color: #2c5282;
}

.badge-rental {
    background: #c6f6d5;
    color: #2f855a;
}

.order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.order-detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.85rem;
    color: var(--gray);
    margin-bottom: 4px;
}

.detail-value {
    font-weight: 500;
    color: var(--dark);
}

.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--gray-light);
}

.cancellation-note {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #c53030;
}

.cancellation-note i {
    margin-right: 5px;
}
/* ================= MOBILE RESPONSIVE STYLES ================= */
@media (max-width: 992px) {
    /* Mobile Menu Button - Always show on mobile */
    .mobile-menu-btn {
        display: flex !important;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 2000;
        background: var(--primary);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        border: none;
        cursor: pointer;
    }
    
    /* Sidebar for mobile - Hidden by default */
    .sidebar {
        transform: translateX(-100%);
        width: var(--sidebar-width);
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1500;
        transition: transform 0.3s ease;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    /* Show all text in sidebar on mobile */
    .sidebar .logo h1 span,
    .sidebar .nav-links a span {
        display: inline !important;
    }
    
    .sidebar .logo h1 {
        justify-content: flex-start;
        gap: 10px;
    }
    
    .sidebar .nav-links a {
        justify-content: flex-start;
        padding: 12px 15px;
    }
    
    /* Main content for mobile */
    .main-content {
        margin-left: 0 !important;
        padding: 20px 15px;
        width: 100%;
    }
}

/* Specific adjustments for different screen sizes */
@media (max-width: 768px) {
    /* General adjustments */
    body {
        font-size: 14px;
    }
    
    /* Header adjustments */
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin-top: 60px; /* Space for mobile menu button */
        padding: 15px 0;
    }
    
    .welcome h2 {
        font-size: 1.4rem;
    }
    
    .header-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    /* Dashboard cards - 2 columns on tablet, 1 column on mobile */
    .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .stat-info h3 {
        font-size: 1.4rem;
    }
    
    .stat-info p {
        font-size: 0.85rem;
    }
    
    /* Section headers */
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .section-header h2 {
        font-size: 1.3rem;
    }
    
    /* Search and filter section */
    .search-filter {
        flex-direction: column;
        gap: 10px;
    }
    
    .search-box,
    .filter-dropdown {
        width: 100%;
        min-width: auto;
    }
    
    /* Equipment grid */
    .items-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    /* Item card adjustments */
    .item-card {
        min-height: auto;
    }
    
    .item-img {
        height: 140px;
    }
    
    .item-info h3 {
        font-size: 1.1rem;
    }
    
    .item-price {
        font-size: 1.1rem;
    }
    
    .item-meta {
        font-size: 0.8rem;
    }
    
    /* Item actions - keep buttons but adjust size */
    .item-actions {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .item-actions .btn {
        padding: 6px 8px;
        font-size: 0.75rem;
        min-width: 70px;
        flex: 1;
        min-height: 36px;
    }
    
    .item-actions .btn i {
        font-size: 0.7rem;
    }
    
    /* Tables - make scrollable */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .data-table {
        min-width: 800px;
        font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px 8px;
    }
    
    /* Modal adjustments */
    .modal-content {
        width: 95%;
        max-height: 85vh;
        margin: 10px;
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: 15px;
    }
    
    .modal-header h3 {
        font-size: 1.2rem;
    }
    
    /* Booking modal container */
    .booking-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    /* Form adjustments */
    .form-row {
        flex-direction: column;
        gap: 0;
    }
    
    /* Calculator adjustments */
    .metrics-container {
        flex-direction: column;
    }
    
    .metric-box {
        margin-bottom: 10px;
    }
    
    .tips-container {
        flex-direction: column;
        gap: 15px;
    }
    
    /* Cart items */
    .cart-items-list .card {
        flex-direction: column;
        text-align: center;
    }
    
    .cart-items-list .card img {
        width: 100%;
        height: 120px;
        margin-bottom: 10px;
    }
    
    /* Orders section */
    .order-details {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .order-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .order-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    /* Reviews section */
    .review-card {
        padding: 15px;
    }
    
    .review-card-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .review-equipment-info {
        width: 100%;
    }
    
    /* Buttons - increase touch target */
    .btn {
        min-height: 44px;
        min-width: 44px;
        padding: 10px 16px;
    }
    
    .btn-sm {
        min-height: 36px;
        min-width: 36px;
        padding: 6px 10px;
    }
    
    /* Input fields for better mobile UX */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        min-height: 44px;
    }
    
    /* Toast notification */
    .toast {
        left: 15px;
        right: 15px;
        bottom: 15px;
        width: calc(100% - 30px);
    }
}

/* Small phones (up to 576px) */
@media (max-width: 576px) {
    /* Single column for everything */
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .items-grid {
        grid-template-columns: 1fr;
    }
    
    .main-content {
        padding: 15px 10px;
    }
    
    .card {
        padding: 15px;
    }
    
    /* Further reduce text sizes */
    .welcome h2 {
        font-size: 1.3rem;
    }
    
    .section-header h2 {
        font-size: 1.2rem;
    }
    
    /* Compact item info */
    .item-info h3 {
        font-size: 1rem;
    }
    
    .item-price {
        font-size: 1rem;
    }
    
    .item-meta {
        font-size: 0.75rem;
    }
    
    /* Item actions - stack buttons vertically on very small screens */
    .item-actions {
        flex-direction: column;
    }
    
    .item-actions .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    /* Adjust modal for very small screens */
    .modal-content {
        width: 98%;
        max-height: 90vh;
        margin: 5px;
    }
    
    /* Calculator stars */
    .rating-stars i {
        font-size: 1.2rem;
    }
    
    /* Hide Google Translate banner on mobile */
    #google_translate_element {
        display: none !important;
    }
}

/* Tablet (769px to 992px) */
@media (min-width: 769px) and (max-width: 992px) {
    /* Keep sidebar collapsed but show text */
    .sidebar {
        width: var(--sidebar-collapsed-width);
        position: fixed;
    }
    
    .sidebar .logo h1 span,
    .sidebar .nav-links a span {
        display: none;
    }
    
    .sidebar .logo h1 {
        justify-content: center;
    }
    
    .sidebar .nav-links a {
        justify-content: center;
        padding: 15px;
    }
    
    .main-content {
        margin-left: var(--sidebar-collapsed-width);
    }
    
    .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .items-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Landscape orientation for mobile */
@media (max-width: 992px) and (orientation: landscape) {
    .sidebar {
        width: 220px;
    }
    
    .main-content {
        padding: 15px;
    }
    
    .items-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-cards {
        grid-template-columns: repeat(3, 1fr);
    }
    
    /* Reduce header height in landscape */
    .header {
        margin-top: 50px;
        padding: 10px 0;
    }
}

/* Fix for iOS Safari specific issues */
@supports (-webkit-touch-callout: none) {
    /* Prevent elastic scrolling on body */
    body {
        position: fixed;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    
    .main-content {
        -webkit-overflow-scrolling: touch;
        overflow-y: auto;
        height: calc(100vh - 60px);
    }
    
    /* Fix for input zoom on iOS */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
        font-size: 16px !important;
    }
    
    /* Fix for sticky hover states on mobile */
    @media (hover: none) {
        .btn:hover,
        .item-card:hover,
        .nav-links a:hover {
            transform: none;
            box-shadow: none;
        }
    }
}

/* Fix for Android Chrome */
@media (hover: hover) {
    /* Only show hover effects on devices that support hover */
    .btn:hover,
    .item-card:hover,
    .nav-links a:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
}

/* Print styles */
@media print {
    .sidebar,
    .header-actions,
    .mobile-menu-btn,
    .item-actions,
    .order-actions,
    .btn {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0 !important;
        padding: 0 !important;
    }
    
    .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        page-break-inside: avoid;
    }
}

/* High DPI screens */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    /* Make sure everything looks sharp */
    .item-img img,
    .user-img,
    .reviewer-avatar {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    /* Optional: Add dark mode styles if needed */
    .card,
    .content-section,
    .modal-content {
        background-color: #1a202c;
        color: #e2e8f0;
        border-color: #2d3748;
    }
}

/* Very large screens */
@media (min-width: 1400px) {
    .main-content {
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .sidebar {
        left: calc((100% - 1400px) / 2);
    }
}

/* Fix for collapsing sidebar on desktop */
@media (min-width: 993px) {
    .mobile-menu-btn {
        display: none !important;
    }
    
    .sidebar {
        transform: translateX(0) !important;
        width: var(--sidebar-width);
    }
    
    .main-content {
        margin-left: var(--sidebar-width);
    }
}

/* Ensure sidebar text is visible when expanded */
.sidebar:not(.collapsed) .logo h1 span,
.sidebar:not(.collapsed) .nav-links a span {
    display: inline !important;
}

/* Smooth transitions */
.sidebar,
.main-content,
.item-card,
.btn,
.modal-content {
    transition: all 0.3s ease;
}

/* Touch-friendly improvements */
button,
input[type="submit"],
input[type="button"] {
    cursor: pointer;
    touch-action: manipulation;
}

/* Ensure select elements are touch-friendly */
select {
    padding: 12px;
    min-height: 44px;
}

/* Fix for scrollbar in modals on mobile */
.modal-body {
    -webkit-overflow-scrolling: touch;
}

/* Improve form field visibility on mobile */
.form-control:focus {
    border-width: 2px;
}

/* Ensure cart icon is visible on mobile */
.cart-icon {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Make sure notification badges are visible */
.notification-btn::after {
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    position: absolute;
    top: 5px;
    right: 5px;
}

/* Adjust logo size for mobile */
@media (max-width: 768px) {
    .logo h1 {
        font-size: 1.2rem;
    }
    
    .logo h1 i {
        font-size: 1.5rem;
    }
}

/* Ensure user profile is visible on mobile */
.user-profile {
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-img {
    width: 36px;
    height: 36px;
}

/* Responsive text for small screens */
@media (max-width: 480px) {
    .user-profile span {
        display: none;
    }
    
    .header-actions {
        gap: 8px;
    }
    
    .notification-btn {
        width: 36px;
        height: 36px;
    }
}
    </style>
</head>
<body>
   
<!-- Google Translate for this page -->
<div id="google_translate_element"></div>
   <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <h1><i class="fas fa-hands-helping"></i> <span>Lend A Hand</span></h1>
        </div>
        
        <ul class="nav-links">
            <li><a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-th-large"></i> <span>Dashboard</span></a></li>
            <li><a href="#" class="nav-link" data-section="browse"><i class="fas fa-search"></i> <span>Browse Equipment</span></a></li>
            <li><a href="#" class="nav-link" data-section="cart"><i class="fas fa-shopping-cart"></i> <span>My Cart</span></a></li>
            <li><a href="#" class="nav-link" data-section="wishlist"><i class="fas fa-heart"></i> <span>Wishlist</span></a></li>
            
            <li><a href="#" class="nav-link" data-section="reviews"><i class="fas fa-star"></i> <span>My Reviews</span></a></li>
            <li><a href="#" class="nav-link" data-section="orders"><i class="fas fa-clipboard-list"></i> <span>My Orders</span></a></li>
            <li><a href="{{ url_for('logout') }}" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="header">
            <div class="welcome">
                <h2 id="welcomeMessage">Welcome, {{ user_name }}! </h2>
                <p>Find and book equipment for your farming needs</p>
                {% if user_email %}
                <p style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;">
                    <i class="fas fa-envelope"></i> {{ user_email }}
                    {% if user_phone %}
                    &nbsp; | &nbsp; <i class="fas fa-phone"></i> {{ user_phone }}
                    {% endif %}
                </p>
                {% endif %}
            </div>
            
            <div class="header-actions">
                <div class="notification-btn">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="notification-btn cart-icon" id="cartIcon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-counter" id="cartCounter" style="display: none;">0</span>
                </div>
                <div class="user-profile">
                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" alt="User" class="user-img">
                    <span id="userName">{{ user_name }}</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="content-section active" id="dashboard-section">
            <!-- Stats Cards -->
            <div class="dashboard-cards">
                <div class="card stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeBookings">0</h3>
                        <p>Active Bookings</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pastBookings">0</h3>
                        <p>Past Bookings</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="wishlistItems">0</h3>
                        <p>Wishlist Items</p>
                    </div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-icon red">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="reviewsWritten">0</h3>
                        <p>Reviews Written</p>
                    </div>
                </div>
            </div>
            
            <!-- Recommended Equipment Section -->
            <div class="card">
                <div class="section-header">
                    <h2>Recommended Equipment</h2>
                    <button class="btn btn-primary view-all-equipment">
                        <i class="fas fa-search"></i> Browse All
                    </button>
                </div>
                
                <div class="items-grid" id="recommendedEquipment">
                    <!-- Recommended equipment will be loaded here -->
                </div>
            </div>
            
            <!-- Upcoming Bookings Section -->
            <div class="card" style="margin-top: 30px;">
                <div class="section-header">
                    <h2>Upcoming Bookings</h2>
                    <button class="btn btn-primary view-all-bookings">
                        <i class="fas fa-list"></i> View All
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Owner</th>
                                <th>Dates</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="upcomingBookingsTable">
                            <!-- Upcoming bookings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Browse Equipment Section -->
        <div class="content-section" id="browse-section">
            <div class="section-header">
                <h2>Browse Equipment</h2>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search for equipment...">
                </div>
                
                <div class="filter-dropdown">
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                        <option value="tractor">Tractor</option>
                        <option value="harvester">Harvester</option>
                        <option value="plough">Plough</option>
                        <option value="irrigation">Irrigation System</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="filter-dropdown">
                    <select id="priceFilter" class="form-control">
                        <option value="">Any Price</option>
                        <option value="0-1000">Under 1,000</option>
                        <option value="1000-5000">1,000 - 5,000</option>
                        <option value="5000-10000">5,000 - 10,000</option>
                        <option value="10000+">Over 10,000</option>
                    </select>
                </div>
                
                <div class="filter-dropdown">
                    <select id="locationFilter" class="form-control">
                        <option value="">Any Location</option>
                        <option value="bangalore">Bangalore</option>
                        <option value="pune">Pune</option>
                        <option value="hyderabad">Hyderabad</option>
                        <option value="chennai">Chennai</option>
                    </select>
                </div>
            </div>
            
            <div class="items-grid" id="browseEquipmentGrid">
                <!-- Equipment items will be loaded here -->
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="content-section" id="cart-section">
            <div class="section-header">
                <h2>My Cart</h2>
                <button class="btn btn-success" id="checkoutBtn">
                    <i class="fas fa-credit-card"></i> Proceed to Checkout
                </button>
            </div>
            
            <div id="cartItemsContainer">
                <!-- Cart items will be loaded here -->
                <div class="no-data" style="text-align: center; padding: 40px; color: var(--gray); display: none;">
                    <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Your cart is empty</h3>
                    <p>Add some equipment to get started!</p>
                </div>
                
                <div class="cart-items-list">
                    <!-- Cart items will be dynamically added here -->
                </div>
                
                <!-- Cart Summary -->
                <div id="cartSummary" class="card" style="margin-top: 20px; display: none;">
                    <div class="section-header">
                        <h3>Order Summary</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>Subtotal:</span>
                            <span id="cartSubtotal">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span>Service Fee (10%):</span>
                            <span id="cartServiceFee">0</span>
                        </div>
                        <hr>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                            <span>Total:</span>
                            <span id="cartTotal">0</span>
                        </div>
                    
                    </div>
                </div>
            </div>
        </div>

        <!-- Wishlist Section -->
        <div class="content-section" id="wishlist-section">
            <div class="section-header">
                <h2>My Wishlist</h2>
            </div>
            
            <div class="items-grid" id="wishlistGrid">
                <!-- Wishlist items will be loaded here -->
            </div>
        </div>
        
        <!-- Loan Calculator Section -->
        <div class="content-section" id="loan-calculator-section">
            <div class="section-header">
                <h2>Loan Calculator</h2>
            </div>
            <div class="card">
                <p>Calculate your equipment financing options and payment schedules.</p>
                <!-- Loan calculator content would go here -->
            </div>
        </div>
        <!-- Replace the entire Reviews section in your userdashboard.html -->
<div class="content-section" id="reviews-section">
    <div class="section-header">
        <h2>My Reviews</h2>
        <button class="btn btn-primary" id="addReviewBtn">
            <i class="fas fa-plus"></i> Write a Review
        </button>
    </div>
    
    <div id="reviewsContainer">
        <div class="no-reviews" style="text-align: center; padding: 40px; color: var(--gray);">
            <i class="fas fa-star" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>No Reviews Yet</h3>
            <p>You haven't written any reviews yet. Share your experience with others!</p>
        </div>
        
        <div class="reviews-list">
            <!-- Reviews will be dynamically added here -->
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal" id="reviewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Write a Review</h3>
            <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="reviewForm">
                <div class="form-group">
                    <label for="reviewOrder">Select Completed Order *</label>
                    <select id="reviewOrder" class="form-control" required>
                        <option value="">-- Select an order to review --</option>
                        <!-- Options will be populated with completed orders -->
                    </select>
                </div>
                
                <div id="selectedOrderInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 id="selectedEquipmentName"></h4>
                    <p><strong>Vendor:</strong> <span id="selectedVendorName"></span></p>
                    <p><strong>Order Type:</strong> <span id="selectedOrderType"></span></p>
                </div>
                
                <div class="form-group">
                    <label for="reviewRating">Rating *</label>
                    <div class="rating-stars" style="display: flex; gap: 5px; margin: 10px 0;">
                        <i class="fas fa-star" data-rating="1" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                        <i class="fas fa-star" data-rating="2" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                        <i class="fas fa-star" data-rating="3" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                        <i class="fas fa-star" data-rating="4" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                        <i class="fas fa-star" data-rating="5" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                    </div>
                    <input type="hidden" id="reviewRating" value="0" required>
                </div>
                
                <div class="form-group">
                    <label for="reviewTitle">Review Title *</label>
                    <input type="text" id="reviewTitle" class="form-control" placeholder="Great equipment!" required>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">Your Review *</label>
                    <textarea id="reviewComment" class="form-control" rows="4" placeholder="Share your experience with this equipment..." required></textarea>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-danger" id="cancelReviewBtn">Cancel</button>
            <button class="btn btn-success" id="submitReviewBtn">Submit Review</button>
        </div>
    </div>
</div>

   
    <!-- Orders Section -->
    <div class="content-section" id="orders-section">
        <div class="section-header">
            <h2>My Orders</h2>
            <p>Manage your bookings and rental requests</p>
        </div>

        <!-- Orders Filters -->
        <div class="search-filter">
            <div class="filter-dropdown">
                <select id="orderTypeFilter" class="form-control">
                    <option value="all">All Types</option>
                    <option value="booking">Bookings</option>
                    <option value="rental">Rentals</option>
                </select>
            </div>
            <div class="filter-dropdown">
                <select id="orderStatusFilter" class="form-control">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="cancellation_requested">Cancellation Requested</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
        </div>

        <!-- Orders Container -->
        <div id="ordersContainer">
            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded here dynamically -->
            </div>
            <div class="no-data" style="text-align: center; padding: 40px; color: var(--gray); display: none;">
                <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>No Orders Found</h3>
                <p>You haven't made any bookings or rental requests yet.</p>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="orderDetailsTitle">Order Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeOrderDetailsModal()">Close</button>
            </div>
        </div>
    </div>

        <!-- Add to user dashboard HTML -->
        <div class="content-section" id="rent-requests-section">
            <div class="section-header">
                <h2>My Rent Requests</h2>
            </div>
            
            <div id="userRentRequestsContainer">
                <!-- Rent requests will be loaded here -->
                <div class="no-data" style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-clipboard-list" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>No Rent Requests</h3>
                    <p>You haven't made any rent requests yet.</p>
                </div>
            </div>
        </div>

    </div> 
   <!-- Booking Modal with Integrated Loan Calculator -->
<div class="modal" id="bookingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Book Equipment</h3>
            <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="booking-container">
                <!-- Left Column: Booking Details -->
                <div class="booking-column">
                    <div class="booking-section">
                        <h3 class="section-title">Equipment Details</h3>
                        <div id="bookingEquipmentInfo" class="equipment-card">
                            <!-- Equipment info will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="booking-section">
                        <h3 class="section-title">Booking Information</h3>
                        <form id="bookingForm">
                            <input type="hidden" id="equipmentId">
                            
                            <!-- Remove date inputs and replace with instant booking message -->
                            <div class="form-group">
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                                    <i class="fas fa-bolt" style="color: var(--secondary); font-size: 1.5rem; margin-bottom: 10px;"></i>
                                    <h4 style="color: var(--secondary); margin-bottom: 10px;">Instant Booking</h4>
                                    <p style="color: var(--dark); margin: 0;">
                                        This equipment will be booked immediately for you. The vendor will contact you to arrange pickup/delivery details.
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="bookingNotes">Special Requests (Optional)</label>
                                <textarea id="bookingNotes" class="form-control" rows="3" placeholder="Any special instructions or requests..."></textarea>
                            </div>
                        </form>
                    </div>
                    
                    <div class="booking-section">
                        <h3 class="section-title">Pricing Summary</h3>
                        <div class="pricing-summary">
                            <div class="price-line">
                                <span>Daily Rate</span>
                                <span><span id="dailyPrice">0</span></span>
                            </div>
                            <div class="price-line">
                                <span>Service Fee (10%)</span>
                                <span><span id="serviceFee">0</span></span>
                            </div>
                            <div class="price-line total">
                                <span><strong>Total Amount</strong></span>
                                <span><strong><span id="bookingTotal">0</span></strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Loan Calculator -->
                <div class="booking-column">
                    <div class="booking-section">
                        <h3 class="section-title">Financing Options</h3>
                        
                        <div class="calculator-toggle">
                            <label for="calculatorOption">Select Financing:</label>
                            <select id="calculatorOption" class="form-control">
                                <option value="none">No Financing (Pay Now)</option>
                                <option value="calculator">Loan Calculator (Financing)</option>
                            </select>
                        </div>
                        
                        <div class="calculator-form" id="loanCalculator" style="display: none;">
                            <div class="calculator-section">
                                <h4 class="calculator-subtitle">Equipment Details</h4>
                                
                                <div class="input-group">
                                    <label for="modalEquipmentName">Equipment Name</label>
                                    <input type="text" id="modalEquipmentName" class="form-control" readonly>
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalEquipmentPrice">Equipment Price ()</label>
                                    <input type="number" id="modalEquipmentPrice" class="form-control" readonly>
                                    <div class="value-display" id="modalEquipmentPriceValue"></div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalEquipmentLifespan">Expected Lifespan (years)</label>
                                    <input type="number" id="modalEquipmentLifespan" class="form-control" value="10" min="1" max="20">
                                    <div class="value-display" id="modalEquipmentLifespanValue">10 years</div>
                                </div>
                            </div>
                            
                            <div class="calculator-section">
                                <h4 class="calculator-subtitle">Loan Details</h4>
                                
                                <div class="input-group">
                                    <label for="modalDownPayment">Down Payment (%)</label>
                                    <input type="number" id="modalDownPayment" class="form-control" value="20" min="0" max="100">
                                    <div class="value-display" id="modalDownPaymentValue">20%</div>
                                    <div class="value-display" id="modalDownPaymentAmount">Down Payment Amount: 0</div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalLoanAmount">Loan Amount</label>
                                    <div class="value-display" id="modalLoanAmountValue">Loan Amount: 0</div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalInterestRate">Annual Interest Rate (%)</label>
                                    <input type="number" id="modalInterestRate" class="form-control" value="8.5" min="1" max="20" step="0.1" readonly>
                                    <div class="value-display" id="modalInterestRateValue">8.5%</div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalLoanTerm">Loan Term (years)</label>
                                    <input type="number" id="modalLoanTerm" class="form-control" value="5" min="1" max="10">
                                    <div class="value-display" id="modalLoanTermValue">5 years</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="calculator-results" id="modalCalculatorResults" style="display: none;">
                            <h4 class="calculator-subtitle">EMI Calculation</h4>
                            
                            <div class="metrics-container">
                                <div class="metric-box">
                                    <div class="metric-title">Monthly EMI</div>
                                    <div class="metric-value" id="modalEmiValue">0</div>
                                </div>
                                
                                <div class="metric-box">
                                    <div class="metric-title">Total Interest</div>
                                    <div class="metric-value" id="modalTotalInterestValue">0</div>
                                </div>
                                
                                <div class="metric-box">
                                    <div class="metric-title">Total Payment</div>
                                    <div class="metric-value" id="modalTotalPaymentValue">0</div>
                                </div>
                            </div>
                            
                            <button id="modalCalculateBtn" class="btn-calculate">
                                <i class="fas fa-calculator"></i> Calculate Payment Schedule
                            </button>
                            
                            <div id="modalScheduleContainer" class="schedule-container" style="display: none;">
                                <h4>Payment Schedule (First 12 Months)</h4>
                                <div class="table-container">
                                    <table class="schedule-table">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Beginning Balance</th>
                                                <th>EMI</th>
                                                <th>Principal</th>
                                                <th>Interest</th>
                                                <th>Outstanding Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalScheduleBody">
                                            <!-- Will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <button id="modalDownloadBtn" class="btn-download">
                                    <i class="fas fa-download"></i> Download Full Schedule as CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="booking-section">
                        <h3 class="section-title">Financing Tips</h3>
                        <div class="tips-container">
                            <div class="tip-box">
                                <i class="fas fa-rupee-sign"></i>
                                <h4>Government Schemes</h4>
                                <p>Check for agricultural subsidies and low-interest loan programs</p>
                            </div>
                            
                            <div class="tip-box">
                                <i class="fas fa-calendar-alt"></i>
                                <h4>Seasonal Planning</h4>
                                <p>Time your purchase to align with harvest seasons</p>
                            </div>
                            
                            <div class="tip-box">
                                <i class="fas fa-tools"></i>
                                <h4>Maintenance Costs</h4>
                                <p>Factor in 2-5% of equipment value annually for maintenance</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-danger" id="cancelBookingBtn">Cancel</button>
            <button class="btn btn-success" id="confirmBookingBtn">
                <i class="fas fa-calendar-check"></i> Confirm Booking
            </button>
        </div>
    </div>
</div>
<!-- Add this NEW rent modal after your booking modal -->
<div class="modal" id="rentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Request Equipment for Rent</h3>
            <button class="close-modal">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="rentForm">
                <input type="hidden" id="rentEquipmentId">
                
                <!-- Equipment Info Display -->
                <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 id="rentEquipmentName" style="margin-bottom: 10px;"></h4>
                    <p id="rentEquipmentDescription" style="margin: 0; color: var(--gray);"></p>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span><strong>Daily Rent:</strong> <span id="rentEquipmentPrice">0</span>/day</span>
                        <span><strong>Vendor:</strong> <span id="rentEquipmentVendor"></span></span>
                    </div>
                </div>
                
                <!-- Rent Details -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="rentStartDate">Start Date *</label>
                        <input type="date" id="rentStartDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="rentEndDate">End Date *</label>
                        <input type="date" id="rentEndDate" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rentPurpose">Purpose of Rental *</label>
                    <textarea id="rentPurpose" class="form-control" rows="3" placeholder="Describe what you need the equipment for..." required></textarea>
                </div>
                
                <!-- Rental Summary -->
                <div class="form-group">
                    <h4>Rental Summary</h4>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Daily Rate (<span id="rentDailyPrice">0</span>  <span id="rentDaysCount">0</span> days)</span>
                            <span><span id="rentBaseTotal">0</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Service Fee (10%)</span>
                            <span><span id="rentServiceFee">0</span></span>
                        </div>
                        <hr style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                            <span>Total Rental Amount</span>
                            <span><span id="rentTotalAmount">0</span></span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-danger" id="cancelRentBtn">Cancel</button>
            <button class="btn btn-success" id="submitRentRequestBtn">
                <i class="fas fa-paper-plane"></i> Submit Rent Request
            </button>
        </div>
    </div>
</div>


    <!-- Review Modal -->
    <div class="modal" id="reviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Write a Review</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="form-group">
                        <label for="reviewEquipment">Select Equipment *</label>
                        <select id="reviewEquipment" class="form-control" required>
                            <option value="">-- Select Equipment --</option>
                            <!-- Options will be populated with completed bookings -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewRating">Rating *</label>
                        <div class="rating-stars" style="display: flex; gap: 5px; margin: 10px 0;">
                            <i class="fas fa-star" data-rating="1" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                            <i class="fas fa-star" data-rating="2" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                            <i class="fas fa-star" data-rating="3" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                            <i class="fas fa-star" data-rating="4" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                            <i class="fas fa-star" data-rating="5" style="font-size: 1.5rem; color: #e2e8f0; cursor: pointer;"></i>
                        </div>
                        <input type="hidden" id="reviewRating" value="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewTitle">Review Title *</label>
                        <input type="text" id="reviewTitle" class="form-control" placeholder="Great equipment!" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewComment">Your Review *</label>
                        <textarea id="reviewComment" class="form-control" rows="4" placeholder="Share your experience with this equipment..." required></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelReviewBtn">Cancel</button>
                <button class="btn btn-success" id="submitReviewBtn">Submit Review</button>
            </div>
        </div>
    </div>

    <script>
       
// Data storage (in a real app, this would come from API)
let equipmentData = [];
let userBookings = JSON.parse(localStorage.getItem('userBookings')) || [];
let userWishlist = JSON.parse(localStorage.getItem('userWishlist')) || [];
let userCart = JSON.parse(localStorage.getItem('userCart')) || [];
let userReviews = JSON.parse(localStorage.getItem('userReviews')) || [];
let vendorReviews = JSON.parse(localStorage.getItem('vendorReviews')) || [];

// Orders Management
let currentOrders = [];
let currentOrderToCancel = null;

// DOM Elements
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const navLinks = document.querySelectorAll('.nav-link');
const contentSections = document.querySelectorAll('.content-section');
const recommendedEquipment = document.getElementById('recommendedEquipment');
const browseEquipmentGrid = document.getElementById('browseEquipmentGrid');
const wishlistGrid = document.getElementById('wishlistGrid');
const upcomingBookingsTable = document.getElementById('upcomingBookingsTable');
const bookingsTable = document.getElementById('bookingsTable');
const bookingModal = document.getElementById('bookingModal');
const closeModalBtn = document.querySelector('.close-modal');
const cancelBookingBtn = document.getElementById('cancelBookingBtn');
const confirmBookingBtn = document.getElementById('confirmBookingBtn');
const logoutBtn = document.getElementById('logoutBtn');
const activeBookingsEl = document.getElementById('activeBookings');
const pastBookingsEl = document.getElementById('pastBookings');
const wishlistItemsEl = document.getElementById('wishlistItems');
const reviewsWrittenEl = document.getElementById('reviewsWritten');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const priceFilter = document.getElementById('priceFilter');
const locationFilter = document.getElementById('locationFilter');
const bookingFilter = document.getElementById('bookingFilter');
const cartCounter = document.getElementById('cartCounter');

// Initialize the dashboard when the page loads
document.addEventListener('DOMContentLoaded', initDashboard);

async function initDashboard() {
    console.log(' Initializing user dashboard...');
    
    // Set the user name in the welcome message
    const userData = {
        name: "{{ user_name }}",
        email: "{{ user_email }}",
        phone: "{{ user_phone }}"
    };
    
    document.getElementById('welcomeMessage').textContent = `Welcome, ${userData.name}!`;
    document.getElementById('userName').textContent = userData.name;
    
    // Load equipment from database first
    await loadEquipmentFromDB();
      setupWishlistEvents();
    
    // Then load all UI components
    loadRecommendedEquipment();
    loadBrowseEquipment();
    loadUpcomingBookings();
    loadWishlist();
    loadCartItems();
    loadReviews();
    updateStats();
    updateCartCounter();
    
    // Set active section based on URL hash or default to dashboard
    const hash = window.location.hash.substring(1) || 'dashboard';
    showSection(hash);
    
    // Set active nav link
    setActiveNavLink(hash);
    
    // Check screen size and toggle mobile menu if needed
    checkScreenSize();
    
    // Set up event listeners for filters
    if (searchInput) searchInput.addEventListener('input', filterEquipment);
    if (categoryFilter) categoryFilter.addEventListener('change', filterEquipment);
    if (priceFilter) priceFilter.addEventListener('change', filterEquipment);
    if (locationFilter) locationFilter.addEventListener('change', filterEquipment);
    if (bookingFilter) bookingFilter.addEventListener('change', filterBookings);
    
    // Set up rating stars
    setupRatingStars();
    
    // Set up loan calculator event listeners
    setupLoanCalculator();
    
    console.log(' User dashboard initialized successfully');
}
// Simple event setup for wishlist
function setupWishlistEvents() {
    // When clicking on the wishlist nav link
    document.querySelector('.nav-link[data-section="wishlist"]').addEventListener('click', function() {
        // Reload wishlist when section is opened
        setTimeout(() => {
            loadWishlist();
        }, 100);
    });
}
function googleTranslateElementInit() {
    new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,kn',
        autoDisplay: false
    }, 'google_translate_element');
    
    // Apply saved language
    const savedLang = localStorage.getItem('selectedLanguage');
    if(savedLang === 'kn') {
        setTimeout(() => {
            var iframe = document.querySelector('.goog-te-menu-frame');
            if(iframe) {
                var select = iframe.contentWindow.document.querySelector('.goog-te-menu2-select');
                if(select) {
                    select.value = 'kn';
                    select.dispatchEvent(new Event('change'));
                }
            }
        }, 1000);
    }
}
var script = document.createElement('script');
script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
document.head.appendChild(script);
// ================= ORDERS MANAGEMENT =================

// Load user orders from database
async function loadUserOrders() {
    try {
        const orderTypeFilter = document.getElementById('orderTypeFilter').value;
        const orderStatusFilter = document.getElementById('orderStatusFilter').value;
        
        const ordersContainer = document.getElementById('ordersList');
        const noDataMsg = document.querySelector('#ordersContainer .no-data');
        
        ordersContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">Loading orders...</p>';
        
        // Build query parameters
        const params = new URLSearchParams();
        if (orderTypeFilter !== 'all') params.append('type', orderTypeFilter);
        if (orderStatusFilter !== 'all') params.append('status', orderStatusFilter);
        
        const response = await fetch(`/api/user/orders?${params}`);
        const orders = await response.json();
        
        console.log(' Orders loaded:', orders);
        
        ordersContainer.innerHTML = '';
        
        if (!orders || orders.length === 0 || orders.error) {
            noDataMsg.style.display = 'block';
            return;
        }
        
        noDataMsg.style.display = 'none';
        
        orders.forEach(order => {
            const orderCard = createOrderCard(order);
            ordersContainer.appendChild(orderCard);
        });
        
        // Setup event listeners after loading orders
        setupOrderEventListeners();
        
    } catch (error) {
        console.error(' Error loading orders:', error);
        const ordersContainer = document.getElementById('ordersList');
        ordersContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--accent);">Error loading orders</p>';
    }
}
// FIXED: Create order card with proper data handling
function createOrderCard(order) {
    const card = document.createElement('div');
    card.className = 'order-card';
    card.dataset.id = order.id;
    card.dataset.type = order.order_type;
    
    const statusClass = getOrderStatusClass(order.status);
    const typeClass = order.order_type === 'booking' ? 'badge-booking' : 'badge-rental';
    const typeText = order.order_type === 'booking' ? 'Booking' : 'Rental';
    
    // Safely handle undefined values
    const vendorName = order.vendor_name || 'Vendor';
    const userName = order.user_name || 'User';
    const userPhone = order.user_phone || 'Not provided';
    const userEmail = order.user_email || 'Not provided';
    
    let actionButtons = '';
    let cancellationNote = '';
    
    // Show cancel button only for orders that can be cancelled
    if (order.can_cancel && !order.is_cancellation_requested) {
        actionButtons = `
            <button class="btn btn-danger btn-sm cancel-order-btn" 
                    data-id="${order.id}" 
                    data-type="${order.order_type}">
                <i class="fas fa-times"></i> Request Cancellation
            </button>
        `;
    }
    
    // Show cancellation requested status
    if (order.is_cancellation_requested) {
        actionButtons = `
            <span class="item-badge badge-maintenance">
                <i class="fas fa-clock"></i> Cancellation Pending
            </span>
        `;
        
        const requestDate = order.cancellation_requested_date ? 
            new Date(order.cancellation_requested_date).toLocaleDateString('en-IN') : 'Recently';
            
        cancellationNote = `
            <div class="cancellation-note">
                <i class="fas fa-clock"></i>
                <strong>Cancellation requested</strong> - waiting for vendor approval
                ${order.cancellation_reason ? `<br><strong>Your reason:</strong> ${order.cancellation_reason}` : ''}
                <br><small>Requested on: ${requestDate}</small>
            </div>
        `;
    }
    
    // Show cancellation details if already cancelled
    if (order.status === 'cancelled') {
        cancellationNote = `
            <div class="cancellation-note approved">
                <i class="fas fa-check-circle"></i>
                <strong>Cancellation approved by vendor</strong>
                ${order.cancellation_reason ? `<br><strong>Your reason:</strong> ${order.cancellation_reason}` : ''}
            </div>
        `;
    }
    
    card.innerHTML = `
        <div class="order-header">
            <h3 class="order-title">${order.equipment_name}</h3>
            <div>
                <span class="order-type-badge ${typeClass}">${typeText}</span>
                <span class="item-badge ${statusClass}">${getOrderStatusText(order.status)}</span>
            </div>
        </div>
        
        <div class="order-details">
            <div class="order-detail-item">
                <span class="detail-label">Vendor</span>
                <span class="detail-value">${vendorName}</span>
            </div>
            
            <div class="order-detail-item">
                <span class="detail-label">Period</span>
                <span class="detail-value">
                    ${order.start_date ? `${formatDisplayDate(order.start_date)} to ${formatDisplayDate(order.end_date)}` : 'Instant Booking'}
                </span>
            </div>
            
            <div class="order-detail-item">
                <span class="detail-label">Duration</span>
                <span class="detail-value">${order.duration || 1} days</span>
            </div>
            
            <div class="order-detail-item">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value">${order.total_amount}</span>
            </div>
            
            <div class="order-detail-item">
                <span class="detail-label">Order Date</span>
                <span class="detail-value">${formatDisplayDate(order.created_date)}</span>
            </div>
        </div>
        
        <div class="order-actions">
            ${actionButtons}
            <button class="btn btn-primary btn-sm view-order-details" 
                    data-id="${order.id}" 
                    data-type="${order.order_type}"
                    data-vendor-name="${vendorName}"
                    data-vendor-email="${order.vendor_email || ''}"
                    data-user-name="${userName}"
                    data-user-email="${userEmail}"
                    data-user-phone="${userPhone}">
                <i class="fas fa-eye"></i> View Details
            </button>
        </div>
        
        ${cancellationNote}
    `;
    
    return card;
}

// ================= REVIEW FUNCTIONS =================

async function loadReviews() {
    try {
        const response = await fetch('/api/user/reviews');
        const reviews = await response.json();
        
        const reviewsContainer = document.querySelector('.reviews-list');
        const noReviewsMsg = document.querySelector('.no-reviews');
        
        if (!reviewsContainer) return;
        
        reviewsContainer.innerHTML = '';
        
        if (!reviews || reviews.length === 0 || reviews.error) {
            if (noReviewsMsg) noReviewsMsg.style.display = 'block';
            return;
        }
        
        if (noReviewsMsg) noReviewsMsg.style.display = 'none';
        
        reviews.forEach(review => {
            const reviewElement = document.createElement('div');
            reviewElement.className = 'card';
            reviewElement.style.marginBottom = '15px';
            reviewElement.style.padding = '20px';
            
            // Create stars based on rating
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="fas fa-star" style="color: ${i <= review.rating ? '#f59e0b' : '#e2e8f0'};"></i>`;
            }
            
            // Format date
            const reviewDate = new Date(review.created_date).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Order type badge
            const orderTypeBadge = review.order_type === 'booking' 
                ? '<span class="order-type-badge badge-booking" style="margin-left: 10px;">Booking</span>'
                : '<span class="order-type-badge badge-rental" style="margin-left: 10px;">Rental</span>';
            
            reviewElement.innerHTML = `
                <div style="display: flex; gap: 15px;">
                    <div style="width: 80px; height: 80px; background: #f5f5f5; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        ${review.equipment_image ? 
                            `<img src="${review.equipment_image}" alt="${review.equipment_name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` :
                            `<i class="fas fa-tractor" style="font-size: 2rem; color: var(--gray);"></i>`
                        }
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin-bottom: 5px; color: var(--dark);">${review.equipment_name}</h3>
                                <div style="margin-bottom: 8px;">
                                    ${starsHtml}
                                    ${orderTypeBadge}
                                    <span style="margin-left: 10px; color: var(--gray); font-size: 0.9rem;">${reviewDate}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm delete-review-btn" data-id="${review.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        <div style="margin-bottom: 8px; color: var(--gray); font-size: 0.9rem;">
                            <i class="fas fa-user"></i> ${review.vendor_name}
                        </div>
                        <h4 style="margin-bottom: 8px; color: var(--primary);">${review.title}</h4>
                        <p style="color: var(--dark); line-height: 1.5;">${review.comment}</p>
                    </div>
                </div>
            `;
            
            reviewsContainer.appendChild(reviewElement);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-review-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteReview(btn.dataset.id));
        });
        
    } catch (error) {
        console.error('Error loading reviews:', error);
    }
}

function showReviewModal() {
    const reviewModal = document.getElementById('reviewModal');
    const reviewOrderSelect = document.getElementById('reviewOrder');
    
    // Clear existing options
    reviewOrderSelect.innerHTML = '<option value="">-- Select an order to review --</option>';
    
    // Fetch completed orders
    fetch('/api/user/completed-orders')
        .then(response => response.json())
        .then(orders => {
            if (orders.error) {
                showToast('Error loading completed orders', 'error');
                return;
            }
            
            if (orders.length === 0) {
                reviewOrderSelect.innerHTML = '<option value="">No completed orders available for review</option>';
                showToast('No completed orders available for review', 'info');
                return;
            }
            
            // Add options for each completed order
            orders.forEach(order => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    order_id: order.order_id,
                    order_type: order.order_type,
                    equipment_id: order.equipment_id,
                    equipment_name: order.equipment_name,
                    vendor_email: order.vendor_email,
                    vendor_name: order.vendor_name
                });
                option.textContent = `${order.equipment_name} (${order.order_type === 'booking' ? 'Booking' : 'Rental'}) - ${new Date(order.created_date).toLocaleDateString()}`;
                reviewOrderSelect.appendChild(option);
            });
            
            // Reset form
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewRating').value = 0;
            document.getElementById('selectedOrderInfo').style.display = 'none';
            
            // Reset stars
            document.querySelectorAll('.rating-stars i').forEach(star => {
                star.style.color = '#e2e8f0';
            });
            
            // Show modal
            reviewModal.style.display = 'flex';
        })
        .catch(error => {
            console.error('Error loading completed orders:', error);
            showToast('Error loading completed orders', 'error');
        });
}

// Event listener for order selection
document.getElementById('reviewOrder').addEventListener('change', function() {
    const selectedOrderInfo = document.getElementById('selectedOrderInfo');
    
    if (this.value) {
        const orderData = JSON.parse(this.value);
        document.getElementById('selectedEquipmentName').textContent = orderData.equipment_name;
        document.getElementById('selectedVendorName').textContent = orderData.vendor_name;
        document.getElementById('selectedOrderType').textContent = orderData.order_type === 'booking' ? 'Booking' : 'Rental';
        selectedOrderInfo.style.display = 'block';
    } else {
        selectedOrderInfo.style.display = 'none';
    }
});

async function submitReview() {
    const reviewOrderSelect = document.getElementById('reviewOrder');
    const rating = document.getElementById('reviewRating').value;
    const title = document.getElementById('reviewTitle').value;
    const comment = document.getElementById('reviewComment').value;
    
    if (!reviewOrderSelect.value) {
        showToast('Please select an order to review', 'error');
        return;
    }
    
    if (rating == 0) {
        showToast('Please provide a rating', 'error');
        return;
    }
    
    if (!title.trim() || !comment.trim()) {
        showToast('Please provide a title and comment for your review', 'error');
        return;
    }
    
    const orderData = JSON.parse(reviewOrderSelect.value);
    
    const reviewData = {
        order_id: orderData.order_id,
        order_type: orderData.order_type,
        equipment_id: orderData.equipment_id,
        equipment_name: orderData.equipment_name,
        vendor_email: orderData.vendor_email,
        vendor_name: orderData.vendor_name,
        rating: parseInt(rating),
        title: title,
        comment: comment
    };
    
    try {
        const response = await fetch('/api/user/reviews/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reviewData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('Review submitted successfully!');
            document.getElementById('reviewModal').style.display = 'none';
            
            // Reload reviews
            loadReviews();
            updateStats();
        } else {
            showToast(result.error || 'Error submitting review', 'error');
        }
    } catch (error) {
        console.error('Error submitting review:', error);
        showToast('Error submitting review', 'error');
    }
}

async function deleteReview(reviewId) {
    if (!confirm('Are you sure you want to delete this review?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user/reviews/${reviewId}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('Review deleted successfully');
            loadReviews();
            updateStats();
        } else {
            showToast(result.error || 'Error deleting review', 'error');
        }
    } catch (error) {
        console.error('Error deleting review:', error);
        showToast('Error deleting review', 'error');
    }
}

async function updateStats() {
    try {
        const response = await fetch('/api/user/reviews');
        const reviews = await response.json();
        
        if (reviews && !reviews.error) {
            const reviewsWrittenEl = document.getElementById('reviewsWritten');
            if (reviewsWrittenEl) {
                reviewsWrittenEl.textContent = reviews.length;
            }
        }
    } catch (error) {
        console.error('Error updating review stats:', error);
    }
}

// Setup rating stars
function setupRatingStars() {
    const ratingStars = document.querySelectorAll('.rating-stars i');
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            document.getElementById('reviewRating').value = rating;
            
            // Update star colors
            ratingStars.forEach((s, index) => {
                if (index < rating) {
                    s.style.color = '#f59e0b';
                } else {
                    s.style.color = '#e2e8f0';
                }
            });
        });
        
        // Add hover effect
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            ratingStars.forEach((s, index) => {
                if (index < rating) {
                    s.style.color = '#f59e0b';
                } else {
                    s.style.color = '#e2e8f0';
                }
            });
        });
    });
}

// Event listeners for review modal
document.getElementById('addReviewBtn').addEventListener('click', showReviewModal);
document.getElementById('submitReviewBtn').addEventListener('click', submitReview);
document.getElementById('cancelReviewBtn').addEventListener('click', function() {
    document.getElementById('reviewModal').style.display = 'none';
});

// Close modal when clicking outside
document.getElementById('reviewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = 'none';
    }
});

// Close modal with escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('reviewModal').style.display = 'none';
    }
});
// FIXED: Display order details in modal with proper data
function displayOrderDetailsModal(orderDetails) {
    const modal = document.getElementById('orderDetailsModal');
    const title = document.getElementById('orderDetailsTitle');
    const content = document.getElementById('orderDetailsContent');
    
    title.textContent = `Order Details - #${orderDetails.id}`;
    
    // Safely handle undefined values
    const userName = orderDetails.user_name || 'Not provided';
    const userEmail = orderDetails.user_email || 'Not provided';
    const userPhone = orderDetails.user_phone || 'Not provided';
    const vendorEmail = orderDetails.vendor_email || 'Not provided';
    const vendorName = orderDetails.vendor_name || 'Not provided';
    
    content.innerHTML = `
        <div class="order-details-container">
            <div class="details-section">
                <h4>Equipment Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Equipment:</span>
                    <span class="detail-value">${orderDetails.equipment_name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Order Type:</span>
                    <span class="detail-value">${orderDetails.order_type || 'N/A'}</span>
                </div>
                ${orderDetails.notes ? `
                <div class="detail-row">
                    <span class="detail-label">Notes:</span>
                    <span class="detail-value">${orderDetails.notes}</span>
                </div>
                ` : ''}
            </div>
            
            <div class="details-section">
                <h4>Order Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value status-${orderDetails.status}">${getOrderStatusText(orderDetails.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Amount:</span>
                    <span class="detail-value">${orderDetails.total_amount || '0'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Order Date:</span>
                    <span class="detail-value">${formatDisplayDate(orderDetails.created_date)}</span>
                </div>
                ${orderDetails.start_date ? `
                <div class="detail-row">
                    <span class="detail-label">Rental Period:</span>
                    <span class="detail-value">${formatDisplayDate(orderDetails.start_date)} to ${formatDisplayDate(orderDetails.end_date)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">${orderDetails.duration || 1} days</span>
                </div>
                ` : ''}
            </div>
            
            <div class="details-section">
                <h4>Vendor Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Vendor:</span>
                    <span class="detail-value">${vendorName}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${vendorEmail}</span>
                </div>
            </div>
            
            <div class="details-section">
                <h4>User Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${userName}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${userEmail}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${userPhone}</span>
                </div>
            </div>
            
            ${orderDetails.cancellation_requested_date ? `
            <div class="details-section">
                <h4>Cancellation Information</h4>
                <div class="detail-row">
                    <span class="detail-label">Cancellation Status:</span>
                    <span class="detail-value">${orderDetails.status === 'cancellation_requested' ? 'Pending Approval' : 'Cancelled'}</span>
                </div>
                ${orderDetails.cancellation_reason ? `
                <div class="detail-row">
                    <span class="detail-label">Cancellation Reason:</span>
                    <span class="detail-value">${orderDetails.cancellation_reason}</span>
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">Requested Date:</span>
                    <span class="detail-value">${formatDisplayDate(orderDetails.cancellation_requested_date)}</span>
                </div>
            </div>
            ` : ''}
        </div>
        
        <style>
            .order-details-container {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .details-section {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid var(--primary);
            }
            .details-section h4 {
                color: var(--primary);
                margin-bottom: 10px;
                border-bottom: 1px solid var(--gray-light);
                padding-bottom: 5px;
            }
            .detail-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding-bottom: 5px;
                border-bottom: 1px solid #e9ecef;
            }
            .detail-row:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            .detail-label {
                font-weight: 600;
                color: var(--dark);
                min-width: 150px;
            }
            .detail-value {
                color: var(--gray);
                text-align: right;
                flex: 1;
            }
            .status-pending { color: #856404; background: #fff3cd; padding: 2px 8px; border-radius: 4px; }
            .status-confirmed { color: #0c5460; background: #d1ecf1; padding: 2px 8px; border-radius: 4px; }
            .status-cancelled { color: #721c24; background: #f8d7da; padding: 2px 8px; border-radius: 4px; }
            .status-completed { color: #155724; background: #d4edda; padding: 2px 8px; border-radius: 4px; }
        </style>
    `;
    
    modal.style.display = 'flex';
}

function closeOrderDetailsModal() {
    const modal = document.getElementById('orderDetailsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function formatDisplayDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString).toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'Invalid Date';
    }
}

// Helper functions
function getOrderStatusClass(status) {
    const statusClasses = {
        'pending': 'status-pending',
        'confirmed': 'status-confirmed',
        'cancellation_requested': 'status-pending',
        'cancelled': 'status-cancelled',
        'completed': 'status-completed'
    };
    return statusClasses[status] || 'status-pending';
}

function getOrderStatusText(status) {
    const statusTexts = {
        'pending': 'Pending',
        'confirmed': 'Confirmed',
        'cancellation_requested': 'Cancellation Requested',
        'cancelled': 'Cancelled',
        'completed': 'Completed'
    };
    return statusTexts[status] || status;
}

// FIXED: Proper event delegation setup
function setupOrderEventListeners() {
    console.log(" Setting up order event listeners...");
    
    // Remove any existing event listeners to prevent duplicates
    document.removeEventListener('click', handleOrderButtonClick);
    
    // Add the event listener
    document.addEventListener('click', handleOrderButtonClick);
}

// FIXED: Handle all order button clicks
function handleOrderButtonClick(e) {
    // Handle Cancel Order buttons
    const cancelBtn = e.target.closest('.cancel-order-btn');
    if (cancelBtn) {
        console.log(' Cancel order button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        const orderId = cancelBtn.getAttribute('data-id');
        const orderType = cancelBtn.getAttribute('data-type');
        
        console.log(` Order details - ID: ${orderId}, Type: ${orderType}`);
        
        if (orderId && orderType) {
            requestCancelOrder(orderType, orderId, cancelBtn);
        } else {
            console.error(' Missing order ID or type');
            showToast('Error: Missing order information', 'error');
        }
        return;
    }
    
    // Handle View Details buttons
    const viewDetailsBtn = e.target.closest('.view-order-details');
    if (viewDetailsBtn) {
        console.log(' View details button clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        const orderId = viewDetailsBtn.getAttribute('data-id');
        const orderType = viewDetailsBtn.getAttribute('data-type');
        
        if (orderId && orderType) {
            viewOrderDetails(orderId, orderType);
        }
        return;
    }
}
// Enhanced cancellation request function with detailed error logging
function requestCancellation(orderId, orderType) {
    const cancellationReason = prompt('Please provide a reason for cancellation:');
    
    if (!cancellationReason) {
        showToast('Cancellation reason is required', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to request cancellation for this order?')) {
        return;
    }
    
    console.log(` Requesting cancellation for ${orderType} #${orderId}`, {
        order_id: orderId,
        order_type: orderType,
        cancellation_reason: cancellationReason,
        user_id: sessionStorage.getItem('user_id') // Check if user is logged in
    });
    
    fetch('/api/user/order/request-cancel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: parseInt(orderId), // Ensure it's a number
            order_type: orderType,
            cancellation_reason: cancellationReason
        })
    })
    .then(response => {
        console.log(' Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            // Try to get detailed error message
            return response.text().then(text => {
                console.error(' Server response text:', text);
                let errorMsg = 'Network error';
                try {
                    const errorData = JSON.parse(text);
                    errorMsg = errorData.error || text;
                } catch (e) {
                    errorMsg = text || 'Unknown error';
                }
                throw new Error(errorMsg);
            });
        }
        return response.json();
    })
    .then(result => {
        console.log(' Cancellation request success:', result);
        if (result.success) {
            showToast(result.message || 'Cancellation request submitted successfully!');
            // Reload orders to update status
            if (typeof loadUserOrders === 'function') {
                loadUserOrders();
            }
        } else {
            showToast(result.error || 'Error submitting cancellation request', 'error');
        }
    })
    .catch(error => {
        console.error(' Cancellation request error details:', {
            error: error.message,
            orderId: orderId,
            orderType: orderType,
            timestamp: new Date().toISOString()
        });
        showToast('Error: ' + error.message, 'error');
    });
}
// SIMPLE: Request cancellation with order details
async function requestCancelOrder(orderType, orderId, button) {
    console.log(` Requesting cancellation for ${orderType} #${orderId}`);
    
    if (!confirm('Are you sure you want to request cancellation? The vendor will need to approve your cancellation request.')) {
        return;
    }
    
    const cancellationReason = prompt('Please provide a reason for cancellation:', '');
    
    // If user clicks cancel on the prompt, don't proceed
    if (cancellationReason === null) {
        return;
    }
    
    // If empty reason, use default
    const finalReason = cancellationReason.trim() || 'No reason provided';
    
    // Show loading state
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    button.disabled = true;
    
    try {
        console.log(` Calling cancellation API for ${orderType} #${orderId}`);
        
        const response = await fetch('/api/user/order/request-cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: parseInt(orderId),
                order_type: orderType,
                cancellation_reason: finalReason
            })
        });
        
        const result = await response.json();
        console.log(' API Response:', result);
        
        if (response.ok && result.success) {
            showToast(' Cancellation request submitted! Waiting for vendor approval.');
            console.log(' Cancellation stored with order details');
            
            // Reload orders to show updated status
            loadUserOrders();
        } else {
            const errorMsg = result.error || 'Error submitting cancellation request';
            console.error(' Cancellation error:', errorMsg);
            showToast(errorMsg, 'error');
        }
    } catch (error) {
        console.error(' Network error:', error);
        showToast('Network error: ' + error.message, 'error');
    } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// FIXED: View order details function with proper data passing
async function viewOrderDetails(orderId, orderType) {
    console.log(` Viewing details for ${orderType} #${orderId}`);
    
    try {
        showToast('Loading order details...');
        
        const response = await fetch(`/api/user/order/${orderId}?type=${orderType}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const orderDetails = await response.json();
        
        if (orderDetails.error) {
            throw new Error(orderDetails.error);
        }
        
        // Ensure all required fields are present
        const completeOrderDetails = {
            ...orderDetails,
            user_name: orderDetails.user_name || 'User',
            user_email: orderDetails.user_email || 'Not provided',
            user_phone: orderDetails.user_phone || 'Not provided',
            vendor_name: orderDetails.vendor_name || 'Vendor',
            vendor_email: orderDetails.vendor_email || 'Not provided'
        };
        
        displayOrderDetailsModal(completeOrderDetails);
        
    } catch (error) {
        console.error(' Error fetching order details:', error);
        showToast('Error loading order details: ' + error.message, 'error');
    }
}

// Order Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize orders when section is shown
    const ordersSection = document.getElementById('orders-section');
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.classList.contains('active')) {
                loadUserOrders();
            }
        });
    });
    
    observer.observe(ordersSection, { attributes: true, attributeFilter: ['class'] });
    
    // Filter event listeners
    document.getElementById('orderTypeFilter').addEventListener('change', loadUserOrders);
    document.getElementById('orderStatusFilter').addEventListener('change', loadUserOrders);
    
    // Close modal when clicking outside
    document.getElementById('orderDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeOrderDetailsModal();
        }
    });
    
    // Close modal with escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeOrderDetailsModal();
        }
    });
});

// Add filter event listeners
document.getElementById('orderTypeFilter')?.addEventListener('change', loadUserOrders);
document.getElementById('orderStatusFilter')?.addEventListener('change', loadUserOrders);

// Initialize orders when section is shown
function showOrdersSection() {
    loadUserOrders();
}

// ================= EQUIPMENT MANAGEMENT =================

// Load equipment from database - FIXED VERSION
async function loadEquipmentFromDB() {
    try {
        console.log(' Loading equipment from database...');
        const response = await fetch('/api/equipment');
        
        if (response.ok) {
            equipmentData = await response.json();
            console.log(' Equipment loaded from DB:', equipmentData.length, 'items');
            
            // Filter only available equipment for users but KEEP ALL DATA including stock
            equipmentData = equipmentData.filter(item => item.status === 'available');
            
            // Store in localStorage for offline use
            localStorage.setItem('equipmentData', JSON.stringify(equipmentData));
            
            return true;
        } else {
            console.error(' Failed to load equipment from database');
            // Fallback to localStorage if available
            const localData = JSON.parse(localStorage.getItem('equipmentData')) || [];
            equipmentData = localData.filter(item => item.status === 'available');
            return false;
        }
    } catch (error) {
        console.error(' Error loading equipment:', error);
        // Fallback to localStorage
        const localData = JSON.parse(localStorage.getItem('equipmentData')) || [];
        equipmentData = localData.filter(item => item.status === 'available');
        return false;
    }
}

// Equipment display functions
function loadRecommendedEquipment() {
    if (!recommendedEquipment) return;
    
    recommendedEquipment.innerHTML = '';
    
    // Show only available items as recommended
    const availableItems = equipmentData.filter(item => item.status === 'available');
    
    if (availableItems.length === 0) {
        recommendedEquipment.innerHTML = '<p class="no-data" style="text-align: center; padding: 40px; color: var(--gray);">No equipment available at the moment.</p>';
        return;
    }
    
    // Show up to 4 recommended items
    const recommendedItems = availableItems.slice(0, 4);
    
    recommendedItems.forEach(item => {
        const equipmentCard = createEquipmentCard(item, true);
        recommendedEquipment.appendChild(equipmentCard);
    });
}

function loadBrowseEquipment() {
    if (!browseEquipmentGrid) return;
    
    browseEquipmentGrid.innerHTML = '';
    
    const availableItems = equipmentData.filter(item => item.status === 'available');
    
    if (availableItems.length === 0) {
        browseEquipmentGrid.innerHTML = '<p class="no-data" style="text-align: center; padding: 40px; color: var(--gray);">No equipment available at the moment.</p>';
        return;
    }
    
    availableItems.forEach(item => {
        const equipmentCard = createEquipmentCard(item, false);
        browseEquipmentGrid.appendChild(equipmentCard);
    });
}

function createEquipmentCard(item, isRecommended) {
    const card = document.createElement('div');
    card.className = 'item-card';
    card.dataset.id = item.id;
    
    const isInWishlist = userWishlist.some(wishlistItem => wishlistItem.id === item.id);
    const isInCart = userCart.some(cartItem => cartItem.id === item.id);
    
    // Use ACTUAL stock data from the database
    const stockQuantity = item.stock_quantity || 0;
    const minStockThreshold = item.min_stock_threshold || 5;
    
    let stockBadge = '';
    let isAvailable = true;
    
    if (stockQuantity <= 0) {
        stockBadge = '<span class="item-badge badge-unavailable">Out of Stock</span>';
        isAvailable = false;
    } else if (stockQuantity <= minStockThreshold) {
        stockBadge = `<span class="item-badge badge-maintenance">Only ${stockQuantity} Left</span>`;
    } else {
        stockBadge = `<span class="item-badge badge-available">In Stock (${stockQuantity})</span>`;
    }
    
    // Handle image display
    let imageHtml = '';
    if (item.image_url && item.image_url !== 'None' && item.image_url !== 'null' && item.image_url.trim() !== '') {
        imageHtml = `
            <img src="${item.image_url}" alt="${item.name}" 
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="default-icon" style="display: none;">
                <i class="fas fa-tractor"></i>
            </div>
        `;
    } else {
        imageHtml = `
            <div class="default-icon">
                <i class="fas fa-tractor"></i>
            </div>
        `;
    }
    
    card.innerHTML = `
        <div class="item-img">
            ${imageHtml}
            ${stockBadge}
        </div>
        <div class="item-info">
            <h3>${item.name}</h3>
            <p>${item.description || 'No description available'}</p>
            
            <!-- Vendor Information -->
            <div class="item-meta" style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-store"></i> <strong>${item.business_name || item.vendor_name}</strong></span>
                    <span style="font-size: 0.8rem; color: var(--gray);">${item.location}</span>
                </div>
            </div>
            
            <div class="item-meta">
                <span><i class="fas fa-map-marker-alt"></i> ${item.location}</span>
                <span><i class="fas fa-user"></i> ${item.vendor_name}</span>
            </div>
            
            <!-- Stock Information - DISPLAY ACTUAL STOCK -->
            <div class="item-meta" style="color: ${stockQuantity <= minStockThreshold ? '#b45309' : 'var(--gray)'};">
                <span><i class="fas fa-box"></i> ${stockQuantity} units available</span>
                ${stockQuantity <= minStockThreshold ? '<span><i class="fas fa-exclamation-triangle"></i> Low stock</span>' : ''}
            </div>
            
            <div class="item-meta">
                <span><i class="fas fa-star" style="color: #f59e0b;"></i> ${item.rating || 4.5} (${item.reviews || 0})</span>
            </div>
            
            <div class="item-price">${item.price ? item.price.toLocaleString() : '0'} / ${item.price_unit || 'day'}</div>
            
            <div class="item-actions">
                <button class="btn btn-primary btn-sm book-btn" data-id="${item.id}" ${!isAvailable ? 'disabled' : ''}>
                    <i class="fas fa-calendar-check"></i> ${isAvailable ? 'Book Now' : 'Out of Stock'}
                </button>
                <button class="btn btn-warning btn-sm rent-btn" data-id="${item.id}" ${!isAvailable ? 'disabled' : ''}>
                    <i class="fas fa-handshake"></i> ${isAvailable ? 'Rent' : 'Unavailable'}
                </button>
                <button class="btn ${isInWishlist ? 'btn-danger' : 'btn-primary'} btn-sm wishlist-btn" data-id="${item.id}">
    <i class="fas ${isInWishlist ? 'fa-heart-broken' : 'fa-heart'}"></i> ${isInWishlist ? 'Unsave' : 'Save'}
</button>
                <button class="btn ${isInCart ? 'btn-success' : 'btn-primary'} btn-sm cart-btn" data-id="${item.id}" ${!isAvailable ? 'disabled' : ''}>
                    <i class="fas ${isInCart ? 'fa-shopping-cart' : 'fa-cart-plus'}"></i> ${isInCart ? 'In Cart' : 'Add to Cart'}
                </button>
            </div>
        </div>
    `;
    
    // Add event listeners to action buttons
    const bookBtn = card.querySelector('.book-btn');
    const rentBtn = card.querySelector('.rent-btn');
    const wishlistBtn = card.querySelector('.wishlist-btn');
    const cartBtn = card.querySelector('.cart-btn');
    
    if (bookBtn && isAvailable) bookBtn.addEventListener('click', () => openBookingModal(item.id));
    if (rentBtn && isAvailable) rentBtn.addEventListener('click', () => openRentModal(item.id));
    if (wishlistBtn) wishlistBtn.addEventListener('click', () => toggleWishlist(item.id));
    if (cartBtn && isAvailable) cartBtn.addEventListener('click', () => toggleCart(item.id));
    
    return card;
}

// Update the equipment loading to include vendor search
function filterEquipment() {
    const searchText = searchInput.value.toLowerCase();
    const category = categoryFilter.value;
    const priceRange = priceFilter.value;
    const location = locationFilter.value;
    
    const filteredItems = equipmentData.filter(item => {
        // Filter by search text (search in equipment name, description, and vendor name)
        if (searchText && 
            !item.name.toLowerCase().includes(searchText) && 
            !item.description.toLowerCase().includes(searchText) &&
            !item.vendor_name.toLowerCase().includes(searchText) &&
            !(item.business_name && item.business_name.toLowerCase().includes(searchText))) {
            return false;
        }
        
        // Filter by category
        if (category && item.category !== category) {
            return false;
        }
        
        // Filter by price range
        if (priceRange) {
            const [min, max] = priceRange.split('-').map(val => val === '+' ? Infinity : parseInt(val));
            if (min && item.price < min) return false;
            if (max && item.price > max) return false;
        }
        
        // Filter by location
        if (location && item.location.toLowerCase() !== location) {
            return false;
        }
        
        return true;
    });
    
    browseEquipmentGrid.innerHTML = '';
    
    if (filteredItems.length === 0) {
        browseEquipmentGrid.innerHTML = '<p class="no-data" style="text-align: center; padding: 40px; color: var(--gray);">No equipment matches your filters.</p>';
        return;
    }
    
    filteredItems.forEach(item => {
        const equipmentCard = createEquipmentCard(item, false);
        browseEquipmentGrid.appendChild(equipmentCard);
    });
}

// ================= BOOKING MODAL FUNCTIONS =================

// Add this function - Open Booking Modal
function openBookingModal(equipmentId) {
    const equipment = equipmentData.find(item => item.id == equipmentId);
    if (!equipment) return;
    
    document.getElementById('equipmentId').value = equipment.id;
    
    // Set equipment info in modal
    const equipmentInfo = document.getElementById('bookingEquipmentInfo');
    equipmentInfo.innerHTML = `
        <h3>${equipment.name}</h3>
        <p>${equipment.description}</p>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <span><i class="fas fa-map-marker-alt"></i> ${equipment.location}</span>
            <span><i class="fas fa-user"></i> ${equipment.vendor_name}</span>
            <span><strong>${equipment.price.toLocaleString()} / ${equipment.price_unit}</strong></span>
        </div>
    `;
    
    // Set pricing information for single day
    const dailyPrice = equipment.price;
    const serviceFee = Math.round(dailyPrice * 0.1);
    const totalAmount = dailyPrice + serviceFee;
    
    document.getElementById('dailyPrice').textContent = dailyPrice.toLocaleString();
    document.getElementById('serviceFee').textContent = serviceFee.toLocaleString();
    document.getElementById('bookingTotal').textContent = totalAmount.toLocaleString();
    
    // Initialize loan calculator with equipment data
    initializeLoanCalculator(equipment);
    
    // Reset loan calculator to default state
    document.getElementById('calculatorOption').value = 'none';
    document.getElementById('loanCalculator').style.display = 'none';
    document.getElementById('modalCalculatorResults').style.display = 'none';
    document.getElementById('modalScheduleContainer').style.display = 'none';
    
    // Show modal
    bookingModal.style.display = 'flex';
}

// Add this function - Confirm Booking
async function confirmBooking() {
    const equipmentId = parseInt(document.getElementById('equipmentId').value);
    const notes = document.getElementById('bookingNotes').value;
    
    // Calculate total amount (1 day + 10% service fee)
    const equipment = equipmentData.find(item => item.id === equipmentId);
    if (!equipment) {
        showToast('Equipment not found', 'error');
        return;
    }
    
    const dailyRate = equipment.price;
    const serviceFee = dailyRate * 0.1;
    const totalAmount = dailyRate + serviceFee;
    
    const bookingData = {
        equipment_id: equipmentId,
        total_amount: totalAmount,
        notes: notes
    };
    
    try {
        const response = await fetch('/api/bookings/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookingData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('Booking submitted successfully!');
            bookingModal.style.display = 'none';
            
            // Refresh equipment list to show updated availability
            await loadEquipmentFromDB();
            loadRecommendedEquipment();
            loadBrowseEquipment();
            
            // Reload bookings
            loadUpcomingBookings();
            updateStats();
            
        } else {
            showToast(result.error || 'Error submitting booking', 'error');
        }
    } catch (error) {
        console.error('Error submitting booking:', error);
        showToast('Error submitting booking', 'error');
    }
}

// ================= RENT FUNCTIONALITY =================

// Rent functionality for user dashboard
function openRentModal(equipmentId) {
    // Get equipment details from your existing equipmentData
    const equipment = equipmentData.find(item => item.id == equipmentId);
    if (!equipment) {
        alert('Equipment not found!');
        return;
    }
    
    document.getElementById('rentEquipmentId').value = equipment.id;
    document.getElementById('rentEquipmentName').textContent = equipment.name;
    document.getElementById('rentEquipmentDescription').textContent = equipment.description;
    document.getElementById('rentEquipmentPrice').textContent = equipment.price;
    document.getElementById('rentEquipmentVendor').textContent = equipment.owner;
    document.getElementById('rentDailyPrice').textContent = equipment.price;
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rentStartDate').min = today;
    document.getElementById('rentEndDate').min = today;
    
    // Reset form
    document.getElementById('rentStartDate').value = '';
    document.getElementById('rentEndDate').value = '';
    document.getElementById('rentPurpose').value = '';
    updateRentPricing();
    
    document.getElementById('rentModal').style.display = 'flex';
}

function updateRentPricing() {
    const startDate = document.getElementById('rentStartDate').value;
    const endDate = document.getElementById('rentEndDate').value;
    const dailyPrice = parseFloat(document.getElementById('rentDailyPrice').textContent) || 0;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        if (daysDiff > 0) {
            const baseTotal = dailyPrice * daysDiff;
            const serviceFee = baseTotal * 0.1;
            const totalAmount = baseTotal + serviceFee;
            
            document.getElementById('rentDaysCount').textContent = daysDiff;
            document.getElementById('rentBaseTotal').textContent = baseTotal.toFixed(2);
            document.getElementById('rentServiceFee').textContent = serviceFee.toFixed(2);
            document.getElementById('rentTotalAmount').textContent = totalAmount.toFixed(2);
        }
    }
}

// Update the submitRentRequest function in user dashboard
function submitRentRequest() {
    const equipmentId = document.getElementById('rentEquipmentId').value;
    const startDate = document.getElementById('rentStartDate').value;
    const endDate = document.getElementById('rentEndDate').value;
    const purpose = document.getElementById('rentPurpose').value;
    
    if (!startDate || !endDate || !purpose) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Validate dates
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (start < today) {
        alert('Start date cannot be in the past');
        return;
    }
    
    if (end <= start) {
        alert('End date must be after start date');
        return;
    }
    
    const rentData = {
        equipment_id: parseInt(equipmentId),
        start_date: startDate,
        end_date: endDate,
        purpose: purpose
    };
    
    fetch('/api/rent/submit-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(rentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Rent request submitted successfully! The equipment will be automatically restocked after the rental period.');
            document.getElementById('rentModal').style.display = 'none';
            
            // Refresh equipment list to show updated availability
            loadBrowseEquipment();
            loadRecommendedEquipment();
            
            // Show success details
            console.log('Rent request details:', {
                id: data.rent_request_id,
                end_date: data.end_date,
                total_amount: data.total_amount
            });
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error submitting rent request:', error);
        alert('Error submitting rent request');
    });
}

// ================= CART FUNCTIONS =================

function toggleCart(equipmentId) {
    const equipment = equipmentData.find(item => item.id === equipmentId);
    if (!equipment) return;
    
    const existingIndex = userCart.findIndex(item => item.id === equipmentId);
    
    if (existingIndex !== -1) {
        // Remove from cart
        userCart.splice(existingIndex, 1);
        showToast('Removed from cart');
    } else {
        // Add to cart
        userCart.push({
            ...equipment,
            quantity: 1,
            selectedDates: null
        });
        showToast('Added to cart');
    }
    
    localStorage.setItem('userCart', JSON.stringify(userCart));
    updateCartCounter();
    
    // Update UI
    loadRecommendedEquipment();
    loadBrowseEquipment();
    loadWishlist();
}

function updateCartCounter() {
    const cartItemsCount = userCart.length;
    
    // Update the cart counter in the header
    if (cartCounter) {
        cartCounter.textContent = cartItemsCount;
        cartCounter.style.display = cartItemsCount > 0 ? 'flex' : 'none';
    }
}

function loadCartItems() {
    const cartContainer = document.querySelector('.cart-items-list');
    const noDataMsg = document.querySelector('#cartItemsContainer .no-data');
    const cartSummary = document.getElementById('cartSummary');
    
    cartContainer.innerHTML = '';
    
    if (userCart.length === 0) {
        noDataMsg.style.display = 'block';
        cartSummary.style.display = 'none';
        return;
    }
    
    noDataMsg.style.display = 'none';
    cartSummary.style.display = 'block';
    
    let subtotal = 0;
    
    userCart.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.className = 'card';
        cartItem.style.marginBottom = '15px';
        cartItem.style.padding = '15px';
        
        cartItem.innerHTML = `
            <div style="display: flex; gap: 15px; align-items: center;">
                <img src="${item.image_url || 'https://images.unsplash.com/photo-1611251432623-4c6c5f90c68c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80'}" alt="${item.name}" style="width: 100px; height: 80px; object-fit: cover; border-radius: 8px;">
                <div style="flex: 1;">
                    <h3 style="margin-bottom: 5px;">${item.name}</h3>
                    <p style="color: var(--gray); margin-bottom: 10px;">${item.description}</p>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>${item.price.toLocaleString()} / ${item.price_unit}</strong></span>
                        <span>${item.location}  ${item.owner}</span>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm remove-cart-item" data-id="${item.id}">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        `;
        
        cartContainer.appendChild(cartItem);
        subtotal += item.price;
    });
    
    // Calculate totals
    const serviceFee = Math.round(subtotal * 0.1);
    const total = subtotal + serviceFee;
    
    document.getElementById('cartSubtotal').textContent = `${subtotal.toLocaleString()}`;
    document.getElementById('cartServiceFee').textContent = `${serviceFee.toLocaleString()}`;
    document.getElementById('cartTotal').textContent = `${total.toLocaleString()}`;
    
    // Add event listeners to remove buttons
    document.querySelectorAll('.remove-cart-item').forEach(btn => {
        btn.addEventListener('click', () => removeFromCart(btn.dataset.id));
    });
}

function removeFromCart(equipmentId) {
    const itemIndex = userCart.findIndex(item => item.id === parseInt(equipmentId));
    if (itemIndex !== -1) {
        userCart.splice(itemIndex, 1);
        localStorage.setItem('userCart', JSON.stringify(userCart));
        
        loadCartItems();
        updateCartCounter();
        loadRecommendedEquipment();
        loadBrowseEquipment();
        
        showToast('Item removed from cart');
    }
}

// ================= WISHLIST FUNCTIONS =================

function loadWishlist() {
    if (!wishlistGrid) return;
    
    console.log('Loading wishlist with', userWishlist.length, 'items');
    
    wishlistGrid.innerHTML = '';
    
    if (userWishlist.length === 0) {
        wishlistGrid.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--gray); width: 100%;">
                <i class="fas fa-heart" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>Your wishlist is empty</h3>
                <p>Save equipment by clicking the heart icon</p>
            </div>
        `;
        return;
    }
    
    // Show each wishlist item
    userWishlist.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.dataset.id = item.id;
        
        card.innerHTML = `
            <div class="item-img">
                ${item.image_url ? `<img src="${item.image_url}" alt="${item.name}">` : 
                  `<div class="default-icon"><i class="fas fa-tractor"></i></div>`}
                <span class="item-badge badge-available">Wishlist</span>
            </div>
            <div class="item-info">
                <h3>${item.name}</h3>
                <p>${item.description || 'No description'}</p>
                
                <div class="item-meta">
                    <span><i class="fas fa-map-marker-alt"></i> ${item.location}</span>
                    <span><i class="fas fa-user"></i> ${item.vendor_name}</span>
                </div>
                
                <div class="item-price">${item.price || '0'} / day</div>
                
                <div class="item-actions">
                    <button class="btn btn-primary btn-sm book-btn">
                        <i class="fas fa-calendar-check"></i> Book
                    </button>
                    <button class="btn btn-danger btn-sm remove-wishlist-btn" data-id="${item.id}">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
        `;
        
        // Add click event to the REMOVE button
        const removeBtn = card.querySelector('.remove-wishlist-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Remove button clicked for:', this.dataset.id);
                toggleWishlist(this.dataset.id);
            });
        }
        
        // Add click event to the BOOK button
        const bookBtn = card.querySelector('.book-btn');
        if (bookBtn) {
            bookBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openBookingModal(item.id);
            });
        }
        
        wishlistGrid.appendChild(card);
    });
}

function toggleWishlist(equipmentId) {
    console.log('Removing item ID:', equipmentId);
    
    // Parse ID to number
    equipmentId = parseInt(equipmentId);
    
    // Find the equipment in equipmentData
    const equipment = equipmentData.find(item => item.id === equipmentId);
    if (!equipment) {
        console.error('Equipment not found:', equipmentId);
        return;
    }
    
    // Check if already in wishlist
    const itemIndex = userWishlist.findIndex(item => item.id === equipmentId);
    
    if (itemIndex !== -1) {
        // REMOVE from wishlist
        const removedItem = userWishlist.splice(itemIndex, 1)[0];
        console.log('Removed from wishlist:', removedItem.name);
        
        // Save to localStorage
        localStorage.setItem('userWishlist', JSON.stringify(userWishlist));
        
        // Show success message
        showToast(`Removed "${removedItem.name}" from wishlist`);
        
        // RELOAD the wishlist section
        loadWishlist();
        
        // Update the wishlist button in other sections
        updateWishlistButtons();
        
        // Update stats
        updateStats();
    } else {
        // ADD to wishlist (if clicked from other sections)
        userWishlist.push(equipment);
        localStorage.setItem('userWishlist', JSON.stringify(userWishlist));
        showToast(`Added "${equipment.name}" to wishlist`);
        updateWishlistButtons();
        updateStats();
    }
}
// Simple function to update wishlist buttons
function updateWishlistButtons() {
    // Update Save/Unsave buttons in browse section
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        const card = button.closest('.item-card');
        if (card) {
            const equipmentId = parseInt(card.dataset.id);
            const isInWishlist = userWishlist.some(item => item.id === equipmentId);
            
            if (isInWishlist) {
                button.innerHTML = '<i class="fas fa-heart-broken"></i> Unsave';
                button.classList.remove('btn-primary');
                button.classList.add('btn-danger');
            } else {
                button.innerHTML = '<i class="fas fa-heart"></i> Save';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
            }
        }
    });
}

// ================= REVIEW FUNCTIONS =================


// Update stats to show actual review count
async function updateStats() {
    try {
        const response = await fetch('/api/user/reviews');
        const reviews = await response.json();
        
        if (reviews && !reviews.error) {
            reviewsWrittenEl.textContent = reviews.length;
        }
    } catch (error) {
        console.error('Error updating review stats:', error);
    }
    
    // Your existing stats code...
    const activeBookings = userBookings.filter(booking => 
        booking.status === 'confirmed' || booking.status === 'active').length;
    activeBookingsEl.textContent = activeBookings;
    
    const pastBookings = userBookings.filter(booking => 
        booking.status === 'completed' || booking.status === 'cancelled').length;
    pastBookingsEl.textContent = pastBookings;
    
    wishlistItemsEl.textContent = userWishlist.length;
}

// ================= UTILITY FUNCTIONS =================

function showSection(sectionId) {
    // Hide all sections
    contentSections.forEach(section => {
        section.classList.remove('active');
    });
    
    // Show the requested section
    const section = document.getElementById(`${sectionId}-section`);
    if (section) {
        section.classList.add('active');
    }
}

function setActiveNavLink(sectionId) {
    // Remove active class from all links
    navLinks.forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active class to the clicked link
    const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }
}

function formatDate(dateString) {
    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    return new Date(dateString).toLocaleDateString('en-IN', options);
}

function checkScreenSize() {
    if (window.innerWidth <= 576) {
        mobileMenuBtn.style.display = 'block';
        sidebar.classList.remove('active');
    } else {
        mobileMenuBtn.style.display = 'none';
        sidebar.classList.add('active');
    }
}

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    if (!toast || !toastMessage) {
        console.log('Toast:', message, type);
        return;
    }
    
    // Set message and style based on type
    toastMessage.textContent = message;
    
    if (type === 'error') {
        toast.style.backgroundColor = 'var(--accent)';
    } else {
        toast.style.backgroundColor = 'var(--secondary)';
    }
    
    // Show toast
    toast.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// ================= EVENT LISTENERS =================

navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        showSection(section);
        setActiveNavLink(section);
        
        // Update URL hash
        window.location.hash = section;
        
        // Close sidebar on mobile after selection
        if (window.innerWidth <= 576) {
            sidebar.classList.remove('active');
        }
    });
});

closeModalBtn.addEventListener('click', () => {
    bookingModal.style.display = 'none';
});

cancelBookingBtn.addEventListener('click', () => {
    bookingModal.style.display = 'none';
});

// FIX THIS EVENT LISTENER
confirmBookingBtn.addEventListener('click', (e) => {
    e.preventDefault();
    confirmBooking();
});

logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm('Are you sure you want to logout?')) {
        // Redirect to Flask logout route
        window.location.href = "/logout";
    }
});

mobileMenuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('active');
});

window.addEventListener('click', (e) => {
    if (e.target === bookingModal) {
        bookingModal.style.display = 'none';
    }
});

window.addEventListener('resize', checkScreenSize);

// Cart icon click event
document.getElementById('cartIcon').addEventListener('click', () => {
    showSection('cart');
    setActiveNavLink('cart');
    loadCartItems();
});

// Rent modal event listeners
document.getElementById('rentStartDate').addEventListener('change', updateRentPricing);
document.getElementById('rentEndDate').addEventListener('change', updateRentPricing);
document.getElementById('submitRentRequestBtn').addEventListener('click', submitRentRequest);
document.getElementById('cancelRentBtn').addEventListener('click', function() {
    document.getElementById('rentModal').style.display = 'none';
});

// Auto-refresh equipment data every 30 seconds
setInterval(async () => {
    console.log(' Auto-refreshing equipment data...');
    await loadEquipmentFromDB();
    loadRecommendedEquipment();
    loadBrowseEquipment();
}, 30000);

// ================= LOAN CALCULATOR FUNCTIONS =================

function setupLoanCalculator() {
    console.log(' Setting up loan calculator...');
    
    const calculatorOption = document.getElementById('calculatorOption');
    if (calculatorOption) {
        calculatorOption.addEventListener('change', function() {
            console.log('Calculator option changed to:', this.value);
            handleCalculatorOptionChange(this.value);
        });
    }
    
    // Add event listeners for loan calculator inputs
    const loanInputs = [
        'modalEquipmentLifespan',
        'modalDownPayment',
        'modalInterestRate',
        'modalLoanTerm'
    ];
    
    loanInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                updateLoanCalculatorValues();
                if (document.getElementById('calculatorOption').value === 'calculator') {
                    calculateLoanPayment();
                }
            });
        }
    });
    
    // Calculate button
    const calculateBtn = document.getElementById('modalCalculateBtn');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateLoanPayment);
    }
    
    // Download button
    const downloadBtn = document.getElementById('modalDownloadBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadPaymentSchedule);
    }
    
    console.log(' Loan calculator setup complete');
}

function initializeLoanCalculator(equipment) {
    if (!equipment) return;
    
    // Set equipment details
    const purchasePrice = equipment.purchasePrice || (equipment.price * 100);
    
    const equipmentNameInput = document.getElementById('modalEquipmentName');
    const equipmentPriceInput = document.getElementById('modalEquipmentPrice');
    
    if (equipmentNameInput) equipmentNameInput.value = equipment.name;
    if (equipmentPriceInput) equipmentPriceInput.value = purchasePrice;
    
    console.log(' Calculator initialized with:', {
        name: equipment.name,
        price: equipment.price,
        purchasePrice: purchasePrice
    });
    
    // Update displayed values immediately
    updateLoanCalculatorValues();
}

function handleCalculatorOptionChange(optionValue) {
    const loanCalculator = document.getElementById('loanCalculator');
    const calculatorResults = document.getElementById('modalCalculatorResults');
    const scheduleContainer = document.getElementById('modalScheduleContainer');
    
    console.log(' Handling calculator option change:', optionValue);
    
    if (optionValue === 'calculator') {
        // Show calculator sections
        if (loanCalculator) loanCalculator.style.display = 'block';
        if (calculatorResults) calculatorResults.style.display = 'block';
        
        // Calculate and display EMI immediately when calculator is shown
        calculateLoanPayment();
    } else {
        // Hide calculator sections
        if (loanCalculator) loanCalculator.style.display = 'none';
        if (calculatorResults) calculatorResults.style.display = 'none';
        if (scheduleContainer) scheduleContainer.style.display = 'none';
    }
}

function updateLoanCalculatorValues() {
    const equipmentPriceInput = document.getElementById('modalEquipmentPrice');
    const downPaymentInput = document.getElementById('modalDownPayment');
    const lifespanInput = document.getElementById('modalEquipmentLifespan');
    const interestRateInput = document.getElementById('modalInterestRate');
    const loanTermInput = document.getElementById('modalLoanTerm');
    
    if (!equipmentPriceInput || !downPaymentInput || !lifespanInput || !interestRateInput || !loanTermInput) {
        return;
    }
    
    const equipmentPrice = parseFloat(equipmentPriceInput.value) || 0;
    const downPaymentPercent = parseFloat(downPaymentInput.value) || 0;
    const lifespan = parseInt(lifespanInput.value) || 10;
    const interestRate = parseFloat(interestRateInput.value) || 8.5;
    const loanTerm = parseInt(loanTermInput.value) || 5;
    
    // Update displayed values
    updateDisplayValue('modalEquipmentPriceValue', `${equipmentPrice.toLocaleString()}`);
    updateDisplayValue('modalEquipmentLifespanValue', `${lifespan} years`);
    updateDisplayValue('modalDownPaymentValue', `${downPaymentPercent}%`);
    updateDisplayValue('modalInterestRateValue', `${interestRate}%`);
    updateDisplayValue('modalLoanTermValue', `${loanTerm} years`);
    
    // Calculate down payment amount
    const downPaymentAmount = (equipmentPrice * downPaymentPercent) / 100;
    updateDisplayValue('modalDownPaymentAmount', `Down Payment Amount: ${downPaymentAmount.toLocaleString()}`);
    
    // Calculate loan amount
    const loanAmount = equipmentPrice - downPaymentAmount;
    updateDisplayValue('modalLoanAmountValue', `Loan Amount: ${loanAmount.toLocaleString()}`);
}

function updateDisplayValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    }
}

function calculateLoanPayment() {
    console.log(' Calculating loan payment...');
    
    const equipmentPrice = parseFloat(document.getElementById('modalEquipmentPrice').value) || 0;
    const downPaymentPercent = parseFloat(document.getElementById('modalDownPayment').value) || 0;
    const interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 8.5;
    const loanTerm = parseInt(document.getElementById('modalLoanTerm').value) || 5;
    
    // Validate inputs
    if (equipmentPrice <= 0) {
        showToast('Please enter a valid equipment price', 'error');
        return;
    }
    
    const downPaymentAmount = (equipmentPrice * downPaymentPercent) / 100;
    const loanAmount = equipmentPrice - downPaymentAmount;
    
    if (loanAmount <= 0) {
        showToast('Down payment is too high. Loan amount must be positive.', 'error');
        return;
    }
    
    const monthlyInterestRate = (interestRate / 100) / 12;
    const numberOfPayments = loanTerm * 12;
    
    // Calculate EMI using the formula: EMI = P  r  (1 + r)^n / ((1 + r)^n - 1)
    const emi = loanAmount * monthlyInterestRate * 
                Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
    
    const totalPayment = emi * numberOfPayments;
    const totalInterest = totalPayment - loanAmount;
    
    // Update results display
    document.getElementById('modalEmiValue').textContent = `${Math.round(emi).toLocaleString()}`;
    document.getElementById('modalTotalInterestValue').textContent = `${Math.round(totalInterest).toLocaleString()}`;
    document.getElementById('modalTotalPaymentValue').textContent = `${Math.round(totalPayment).toLocaleString()}`;
    
    // Generate payment schedule
    generatePaymentSchedule(loanAmount, monthlyInterestRate, numberOfPayments, emi);
    
    // Show schedule container
    document.getElementById('modalScheduleContainer').style.display = 'block';
    
    console.log(' EMI calculation completed');
}

function generatePaymentSchedule(loanAmount, monthlyInterestRate, numberOfPayments, emi) {
    const scheduleBody = document.getElementById('modalScheduleBody');
    scheduleBody.innerHTML = '';
    
    let outstandingBalance = loanAmount;
    
    for (let month = 1; month <= Math.min(12, numberOfPayments); month++) {
        const interestPayment = outstandingBalance * monthlyInterestRate;
        const principalPayment = emi - interestPayment;
        const beginningBalance = outstandingBalance;
        
        outstandingBalance -= principalPayment;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${month}</td>
            <td>${Math.round(beginningBalance).toLocaleString()}</td>
            <td>${Math.round(emi).toLocaleString()}</td>
            <td>${Math.round(principalPayment).toLocaleString()}</td>
            <td>${Math.round(interestPayment).toLocaleString()}</td>
            <td>${Math.round(outstandingBalance).toLocaleString()}</td>
        `;
        scheduleBody.appendChild(row);
    }
}

function downloadPaymentSchedule() {
    const equipmentName = document.getElementById('modalEquipmentName').value;
    const equipmentPrice = parseFloat(document.getElementById('modalEquipmentPrice').value) || 0;
    const downPaymentPercent = parseFloat(document.getElementById('modalDownPayment').value) || 0;
    const interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 8.5;
    const loanTerm = parseInt(document.getElementById('modalLoanTerm').value) || 5;
    
    const downPaymentAmount = (equipmentPrice * downPaymentPercent) / 100;
    const loanAmount = equipmentPrice - downPaymentAmount;
    const monthlyInterestRate = (interestRate / 100) / 12;
    const numberOfPayments = loanTerm * 12;
    
    const emi = loanAmount * monthlyInterestRate * 
                Math.pow(1 + monthlyInterestRate, numberOfPayments) / 
                (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
    
    // Create CSV content
    let csvContent = "Payment Schedule for " + equipmentName + "\n";
    csvContent += "Equipment Price: " + equipmentPrice.toLocaleString() + "\n";
    csvContent += "Down Payment: " + downPaymentAmount.toLocaleString() + " (" + downPaymentPercent + "%)\n";
    csvContent += "Loan Amount: " + loanAmount.toLocaleString() + "\n";
    csvContent += "Interest Rate: " + interestRate + "%\n";
    csvContent += "Loan Term: " + loanTerm + " years\n";
    csvContent += "Monthly EMI: " + Math.round(emi).toLocaleString() + "\n\n";
    
    csvContent += "Month,Beginning Balance,EMI,Principal,Interest,Outstanding Balance\n";
    
    let outstandingBalance = loanAmount;
    
    for (let month = 1; month <= numberOfPayments; month++) {
        const interestPayment = outstandingBalance * monthlyInterestRate;
        const principalPayment = emi - interestPayment;
        const beginningBalance = outstandingBalance;
        
        outstandingBalance -= principalPayment;
        
        csvContent += month + "," + Math.round(beginningBalance) + "," + Math.round(emi) + 
                     "," + Math.round(principalPayment) + "," + Math.round(interestPayment) + 
                     "," + Math.round(outstandingBalance) + "\n";
    }
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'payment_schedule_' + equipmentName.replace(/\s+/g, '_') + '.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showToast('Payment schedule downloaded successfully!');
}

// ================= BOOKING TABLE FUNCTIONS =================

function loadUpcomingBookings() {
    fetch('/api/user/bookings')
        .then(response => response.json())
        .then(bookings => {
            const tableBody = document.getElementById('upcomingBookingsTable');
            tableBody.innerHTML = '';
            
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">No upcoming bookings.</td></tr>';
                return;
            }
            
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                
                const statusClass = 
                    booking.status === 'confirmed' ? 'badge-available' : 
                    booking.status === 'pending' ? 'badge-maintenance' : '';
                
                row.innerHTML = `
                    <td>${booking.equipment_name}</td>
                    <td>${booking.vendor_name}</td>
                    <td>Instant Booking</td>
                    <td>${booking.total_amount}</td>
                    <td><span class="item-badge ${statusClass}">${booking.status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm view-booking-btn" data-id="${booking.id}">View</button>
                        ${booking.status === 'pending' ? 
                            `<button class="btn btn-danger btn-sm cancel-booking-btn" data-id="${booking.id}">Cancel</button>` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading bookings:', error);
        });
}

function filterBookings() {
    const statusFilter = bookingFilter.value;
    
    const filteredBookings = statusFilter === 'all' 
        ? userBookings 
        : userBookings.filter(booking => booking.status === statusFilter);
    
    bookingsTable.innerHTML = '';
    
    if (filteredBookings.length === 0) {
        bookingsTable.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--gray);">No bookings match your filter.</td></tr>';
        return;
    }
    
    filteredBookings.forEach(booking => {
        const row = document.createElement('tr');
        
        const statusClass = 
            booking.status === 'confirmed' ? 'badge-available' : 
            booking.status === 'active' ? 'badge-maintenance' : 
            booking.status === 'completed' ? 'badge-available' : 
            booking.status === 'cancelled' ? 'badge-unavailable' : '';
        
        row.innerHTML = `
            <td>#${booking.id}</td>
            <td>${booking.equipmentName}</td>
            <td>${booking.owner}</td>
            <td>${formatDate(booking.startDate)} to ${formatDate(booking.endDate)}</td>
            <td>${booking.total.toLocaleString()}</td>
            <td><span class="item-badge ${statusClass}">${booking.status}</span></td>
            <td>
                <button class="btn btn-primary btn-sm view-booking-btn" data-id="${booking.id}">View</button>
                ${booking.status === 'confirmed' ? 
                    `<button class="btn btn-danger btn-sm cancel-booking-btn" data-id="${booking.id}">Cancel</button>` : ''}
                ${booking.status === 'completed' ? 
                    `<button class="btn btn-success btn-sm review-btn" data-id="${booking.id}">Review</button>` : ''}
            </td>
        `;
        
        bookingsTable.appendChild(row);
    });
}

// ================= SETUP RATING STARS =================

function setupRatingStars() {
    const ratingStars = document.querySelectorAll('.rating-stars i');
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            document.getElementById('reviewRating').value = rating;
            
            // Update star colors
            ratingStars.forEach((s, index) => {
                if (index < rating) {
                    s.style.color = '#f59e0b';
                } else {
                    s.style.color = '#e2e8f0';
                }
            });
        });
    });
}

</script>
<style>.goog-te-banner-frame{display:none!important;}.goog-te-gadget{font-size:0!important;}</style>
</body>
</html>

